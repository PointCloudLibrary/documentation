<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Robust pose estimation of rigid objects &mdash; Point Cloud Library 1.14.1-dev documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> Point Cloud Library
          </a>
              <div class="version">
                1.14.1-dev
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">Robust pose estimation of rigid objects</a></li>
<li><a class="reference internal" href="#the-code">The code</a></li>
<li><a class="reference internal" href="#the-explanation">The explanation</a></li>
<li><a class="reference internal" href="#compiling-and-running-the-program">Compiling and running the program</a></li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Point Cloud Library</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Robust pose estimation of rigid objects</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="robust-pose-estimation-of-rigid-objects">
<span id="alignment-prerejective"></span><h1>Robust pose estimation of rigid objects</h1>
<p>In this tutorial, we show how to find the alignment pose of a rigid object in a scene with clutter and occlusions.</p>
</section>
<section id="the-code">
<h1>The code</h1>
<p>First, download the test models: <a class="reference download internal" download="" href="_downloads/da6e6b8fbf78b559884f14174ad67c01/chef.pcd"><code class="xref download docutils literal notranslate"><span class="pre">object</span></code></a> and <a class="reference download internal" download="" href="_downloads/eb5b16fe36d0ec907bd4c65335af7cb7/rs1.pcd"><code class="xref download docutils literal notranslate"><span class="pre">scene</span></code></a>.</p>
<p>Next, copy and paste the following code into your editor and save it as <code class="docutils literal notranslate"><span class="pre">alignment_prerejective.cpp</span></code> (or download the source file <a class="reference download internal" download="" href="_downloads/d7abd89b5c0433157a28b83800f393ff/alignment_prerejective.cpp"><code class="xref download docutils literal notranslate"><span class="pre">here</span></code></a>).</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Eigen/Core&gt;</span><span class="cp"></span>
<span class="linenos">  2</span>
<span class="linenos">  3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/point_types.h&gt;</span><span class="cp"></span>
<span class="linenos">  4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/point_cloud.h&gt;</span><span class="cp"></span>
<span class="linenos">  5</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/common/time.h&gt;</span><span class="cp"></span>
<span class="linenos">  6</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/console/print.h&gt;</span><span class="cp"></span>
<span class="linenos">  7</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/features/normal_3d_omp.h&gt;</span><span class="cp"></span>
<span class="linenos">  8</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/features/fpfh_omp.h&gt;</span><span class="cp"></span>
<span class="linenos">  9</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/filters/filter.h&gt;</span><span class="cp"></span>
<span class="linenos"> 10</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/filters/voxel_grid.h&gt;</span><span class="cp"></span>
<span class="linenos"> 11</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/io/pcd_io.h&gt;</span><span class="cp"></span>
<span class="linenos"> 12</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/registration/sample_consensus_prerejective.h&gt;</span><span class="cp"></span>
<span class="linenos"> 13</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/visualization/pcl_visualizer.h&gt;</span><span class="cp"></span>
<span class="linenos"> 14</span>
<span class="linenos"> 15</span><span class="c1">// Types</span>
<span class="linenos"> 16</span><span class="k">typedef</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointNormal</span><span class="w"> </span><span class="n">PointNT</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 17</span><span class="k">typedef</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="o">&lt;</span><span class="n">PointNT</span><span class="o">&gt;</span><span class="w"> </span><span class="n">PointCloudT</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 18</span><span class="k">typedef</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">FPFHSignature33</span><span class="w"> </span><span class="n">FeatureT</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 19</span><span class="k">typedef</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">FPFHEstimationOMP</span><span class="o">&lt;</span><span class="n">PointNT</span><span class="p">,</span><span class="n">PointNT</span><span class="p">,</span><span class="n">FeatureT</span><span class="o">&gt;</span><span class="w"> </span><span class="n">FeatureEstimationT</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 20</span><span class="k">typedef</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="o">&lt;</span><span class="n">FeatureT</span><span class="o">&gt;</span><span class="w"> </span><span class="n">FeatureCloudT</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 21</span><span class="k">typedef</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">visualization</span><span class="o">::</span><span class="n">PointCloudColorHandlerCustom</span><span class="o">&lt;</span><span class="n">PointNT</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ColorHandlerT</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 22</span>
<span class="linenos"> 23</span><span class="c1">// Align a rigid object to a scene with clutter and occlusions</span>
<span class="linenos"> 24</span><span class="kt">int</span><span class="w"></span>
<span class="linenos"> 25</span><span class="nf">main</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 26</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 27</span><span class="w">  </span><span class="c1">// Point clouds</span>
<span class="linenos"> 28</span><span class="w">  </span><span class="n">PointCloudT</span><span class="o">::</span><span class="n">Ptr</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">PointCloudT</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 29</span><span class="w">  </span><span class="n">PointCloudT</span><span class="o">::</span><span class="n">Ptr</span><span class="w"> </span><span class="n">object_aligned</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">PointCloudT</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 30</span><span class="w">  </span><span class="n">PointCloudT</span><span class="o">::</span><span class="n">Ptr</span><span class="w"> </span><span class="n">scene_before_downsampling</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">PointCloudT</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 31</span><span class="w">  </span><span class="n">PointCloudT</span><span class="o">::</span><span class="n">Ptr</span><span class="w"> </span><span class="n">scene</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">PointCloudT</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 32</span><span class="w">  </span><span class="n">FeatureCloudT</span><span class="o">::</span><span class="n">Ptr</span><span class="w"> </span><span class="n">object_features</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">FeatureCloudT</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 33</span><span class="w">  </span><span class="n">FeatureCloudT</span><span class="o">::</span><span class="n">Ptr</span><span class="w"> </span><span class="n">scene_features</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">FeatureCloudT</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 34</span><span class="w">  </span>
<span class="linenos"> 35</span><span class="w">  </span><span class="c1">// Get input object and scene</span>
<span class="linenos"> 36</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 37</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 38</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_error</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Syntax is: %s object.pcd scene.pcd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="linenos"> 39</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 40</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 41</span><span class="w">  </span>
<span class="linenos"> 42</span><span class="w">  </span><span class="c1">// Load object and scene</span>
<span class="linenos"> 43</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_highlight</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Loading point clouds...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 44</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pcl</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">loadPCDFile</span><span class="o">&lt;</span><span class="n">PointNT</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="o">*</span><span class="n">object</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="linenos"> 45</span><span class="w">      </span><span class="n">pcl</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">loadPCDFile</span><span class="o">&lt;</span><span class="n">PointNT</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="o">*</span><span class="n">scene_before_downsampling</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 46</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 47</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_error</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Error loading object/scene file!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 48</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 49</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 50</span><span class="w">  </span>
<span class="linenos"> 51</span><span class="w">  </span><span class="c1">// Downsample</span>
<span class="linenos"> 52</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_highlight</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Downsampling...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 53</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">VoxelGrid</span><span class="o">&lt;</span><span class="n">PointNT</span><span class="o">&gt;</span><span class="w"> </span><span class="n">grid</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 54</span><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">leaf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.005f</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 55</span><span class="w">  </span><span class="n">grid</span><span class="p">.</span><span class="n">setLeafSize</span><span class="w"> </span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span><span class="w"> </span><span class="n">leaf</span><span class="p">,</span><span class="w"> </span><span class="n">leaf</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 56</span><span class="w">  </span><span class="n">grid</span><span class="p">.</span><span class="n">setInputCloud</span><span class="w"> </span><span class="p">(</span><span class="n">object</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 57</span><span class="w">  </span><span class="n">grid</span><span class="p">.</span><span class="n">filter</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">object</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 58</span><span class="w">  </span><span class="n">grid</span><span class="p">.</span><span class="n">setInputCloud</span><span class="w"> </span><span class="p">(</span><span class="n">scene_before_downsampling</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 59</span><span class="w">  </span><span class="n">grid</span><span class="p">.</span><span class="n">filter</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">scene</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 60</span><span class="w">  </span>
<span class="linenos"> 61</span><span class="w">  </span><span class="c1">// Estimate normals for scene</span>
<span class="linenos"> 62</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_highlight</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Estimating scene normals...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 63</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">NormalEstimationOMP</span><span class="o">&lt;</span><span class="n">PointNT</span><span class="p">,</span><span class="n">PointNT</span><span class="o">&gt;</span><span class="w"> </span><span class="n">nest</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 64</span><span class="w">  </span><span class="n">nest</span><span class="p">.</span><span class="n">setRadiusSearch</span><span class="w"> </span><span class="p">(</span><span class="mf">0.005</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 65</span><span class="w">  </span><span class="n">nest</span><span class="p">.</span><span class="n">setInputCloud</span><span class="w"> </span><span class="p">(</span><span class="n">scene</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 66</span><span class="w">  </span><span class="n">nest</span><span class="p">.</span><span class="n">setSearchSurface</span><span class="w"> </span><span class="p">(</span><span class="n">scene_before_downsampling</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 67</span><span class="w">  </span><span class="n">nest</span><span class="p">.</span><span class="n">compute</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">scene</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 68</span><span class="w">  </span>
<span class="linenos"> 69</span><span class="w">  </span><span class="c1">// Estimate features</span>
<span class="linenos"> 70</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_highlight</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Estimating features...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 71</span><span class="w">  </span><span class="n">FeatureEstimationT</span><span class="w"> </span><span class="n">fest</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 72</span><span class="w">  </span><span class="n">fest</span><span class="p">.</span><span class="n">setRadiusSearch</span><span class="w"> </span><span class="p">(</span><span class="mf">0.025</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 73</span><span class="w">  </span><span class="n">fest</span><span class="p">.</span><span class="n">setInputCloud</span><span class="w"> </span><span class="p">(</span><span class="n">object</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 74</span><span class="w">  </span><span class="n">fest</span><span class="p">.</span><span class="n">setInputNormals</span><span class="w"> </span><span class="p">(</span><span class="n">object</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 75</span><span class="w">  </span><span class="n">fest</span><span class="p">.</span><span class="n">compute</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">object_features</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 76</span><span class="w">  </span><span class="n">fest</span><span class="p">.</span><span class="n">setInputCloud</span><span class="w"> </span><span class="p">(</span><span class="n">scene</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 77</span><span class="w">  </span><span class="n">fest</span><span class="p">.</span><span class="n">setInputNormals</span><span class="w"> </span><span class="p">(</span><span class="n">scene</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 78</span><span class="w">  </span><span class="n">fest</span><span class="p">.</span><span class="n">compute</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">scene_features</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 79</span><span class="w">  </span>
<span class="linenos"> 80</span><span class="w">  </span><span class="c1">// Perform alignment</span>
<span class="linenos"> 81</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_highlight</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Starting alignment...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 82</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">SampleConsensusPrerejective</span><span class="o">&lt;</span><span class="n">PointNT</span><span class="p">,</span><span class="n">PointNT</span><span class="p">,</span><span class="n">FeatureT</span><span class="o">&gt;</span><span class="w"> </span><span class="n">align</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 83</span><span class="w">  </span><span class="n">align</span><span class="p">.</span><span class="n">setInputSource</span><span class="w"> </span><span class="p">(</span><span class="n">object</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 84</span><span class="w">  </span><span class="n">align</span><span class="p">.</span><span class="n">setSourceFeatures</span><span class="w"> </span><span class="p">(</span><span class="n">object_features</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 85</span><span class="w">  </span><span class="n">align</span><span class="p">.</span><span class="n">setInputTarget</span><span class="w"> </span><span class="p">(</span><span class="n">scene</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 86</span><span class="w">  </span><span class="n">align</span><span class="p">.</span><span class="n">setTargetFeatures</span><span class="w"> </span><span class="p">(</span><span class="n">scene_features</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 87</span><span class="w">  </span><span class="n">align</span><span class="p">.</span><span class="n">setMaximumIterations</span><span class="w"> </span><span class="p">(</span><span class="mi">50000</span><span class="p">);</span><span class="w"> </span><span class="c1">// Number of RANSAC iterations</span>
<span class="linenos"> 88</span><span class="w">  </span><span class="n">align</span><span class="p">.</span><span class="n">setNumberOfSamples</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="p">);</span><span class="w"> </span><span class="c1">// Number of points to sample for generating/prerejecting a pose</span>
<span class="linenos"> 89</span><span class="w">  </span><span class="n">align</span><span class="p">.</span><span class="n">setCorrespondenceRandomness</span><span class="w"> </span><span class="p">(</span><span class="mi">5</span><span class="p">);</span><span class="w"> </span><span class="c1">// Number of nearest features to use</span>
<span class="linenos"> 90</span><span class="w">  </span><span class="n">align</span><span class="p">.</span><span class="n">setSimilarityThreshold</span><span class="w"> </span><span class="p">(</span><span class="mf">0.95f</span><span class="p">);</span><span class="w"> </span><span class="c1">// Polygonal edge length similarity threshold</span>
<span class="linenos"> 91</span><span class="w">  </span><span class="n">align</span><span class="p">.</span><span class="n">setMaxCorrespondenceDistance</span><span class="w"> </span><span class="p">(</span><span class="mf">2.5f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">leaf</span><span class="p">);</span><span class="w"> </span><span class="c1">// Inlier threshold</span>
<span class="linenos"> 92</span><span class="w">  </span><span class="n">align</span><span class="p">.</span><span class="n">setInlierFraction</span><span class="w"> </span><span class="p">(</span><span class="mf">0.25f</span><span class="p">);</span><span class="w"> </span><span class="c1">// Required inlier fraction for accepting a pose hypothesis</span>
<span class="linenos"> 93</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 94</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">ScopeTime</span><span class="w"> </span><span class="n">t</span><span class="p">(</span><span class="s">&quot;Alignment&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 95</span><span class="w">    </span><span class="n">align</span><span class="p">.</span><span class="n">align</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">object_aligned</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 96</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 97</span><span class="w">  </span>
<span class="linenos"> 98</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">align</span><span class="p">.</span><span class="n">hasConverged</span><span class="w"> </span><span class="p">())</span><span class="w"></span>
<span class="linenos"> 99</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos">100</span><span class="w">    </span><span class="c1">// Print results</span>
<span class="linenos">101</span><span class="w">    </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">102</span><span class="w">    </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix4f</span><span class="w"> </span><span class="n">transformation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">align</span><span class="p">.</span><span class="n">getFinalTransformation</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="linenos">103</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_info</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;    | %6.3f %6.3f %6.3f | </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">transformation</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">transformation</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">transformation</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span><span class="w"></span>
<span class="linenos">104</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_info</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;R = | %6.3f %6.3f %6.3f | </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">transformation</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">transformation</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">transformation</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span><span class="w"></span>
<span class="linenos">105</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_info</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;    | %6.3f %6.3f %6.3f | </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">transformation</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">transformation</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">transformation</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span><span class="w"></span>
<span class="linenos">106</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_info</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">107</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_info</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;t = &lt; %0.3f, %0.3f, %0.3f &gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">transformation</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="n">transformation</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="n">transformation</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">));</span><span class="w"></span>
<span class="linenos">108</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_info</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">109</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_info</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Inliers: %i/%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">align</span><span class="p">.</span><span class="n">getInliers</span><span class="w"> </span><span class="p">().</span><span class="n">size</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">object</span><span class="o">-&gt;</span><span class="n">size</span><span class="w"> </span><span class="p">());</span><span class="w"></span>
<span class="linenos">110</span><span class="w">    </span>
<span class="linenos">111</span><span class="w">    </span><span class="c1">// Show alignment</span>
<span class="linenos">112</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">visualization</span><span class="o">::</span><span class="n">PCLVisualizer</span><span class="w"> </span><span class="n">visu</span><span class="p">(</span><span class="s">&quot;Alignment&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">113</span><span class="w">    </span><span class="n">visu</span><span class="p">.</span><span class="n">addPointCloud</span><span class="w"> </span><span class="p">(</span><span class="n">scene</span><span class="p">,</span><span class="w"> </span><span class="n">ColorHandlerT</span><span class="w"> </span><span class="p">(</span><span class="n">scene</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">255.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;scene&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">114</span><span class="w">    </span><span class="n">visu</span><span class="p">.</span><span class="n">addPointCloud</span><span class="w"> </span><span class="p">(</span><span class="n">object_aligned</span><span class="p">,</span><span class="w"> </span><span class="n">ColorHandlerT</span><span class="w"> </span><span class="p">(</span><span class="n">object_aligned</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">255.0</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;object_aligned&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">115</span><span class="w">    </span><span class="n">visu</span><span class="p">.</span><span class="n">spin</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="linenos">116</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">117</span><span class="w">  </span><span class="k">else</span><span class="w"></span>
<span class="linenos">118</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos">119</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_error</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Alignment failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">120</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">121</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">122</span><span class="w">  </span>
<span class="linenos">123</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="linenos">124</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="the-explanation">
<h1>The explanation</h1>
<p>We start by defining convenience types in order not to clutter the code.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Types</span>
<span class="k">typedef</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointNormal</span><span class="w"> </span><span class="n">PointNT</span><span class="p">;</span><span class="w"></span>
<span class="k">typedef</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="o">&lt;</span><span class="n">PointNT</span><span class="o">&gt;</span><span class="w"> </span><span class="n">PointCloudT</span><span class="p">;</span><span class="w"></span>
<span class="k">typedef</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">FPFHSignature33</span><span class="w"> </span><span class="n">FeatureT</span><span class="p">;</span><span class="w"></span>
<span class="k">typedef</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">FPFHEstimationOMP</span><span class="o">&lt;</span><span class="n">PointNT</span><span class="p">,</span><span class="n">PointNT</span><span class="p">,</span><span class="n">FeatureT</span><span class="o">&gt;</span><span class="w"> </span><span class="n">FeatureEstimationT</span><span class="p">;</span><span class="w"></span>
<span class="k">typedef</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="o">&lt;</span><span class="n">FeatureT</span><span class="o">&gt;</span><span class="w"> </span><span class="n">FeatureCloudT</span><span class="p">;</span><span class="w"></span>
<span class="k">typedef</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">visualization</span><span class="o">::</span><span class="n">PointCloudColorHandlerCustom</span><span class="o">&lt;</span><span class="n">PointNT</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ColorHandlerT</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Then we instantiate the necessary data containers, check the input arguments and load the object and scene point clouds. Although we have defined the basic point type to contain normals, we only have those in advance for the object (which is often the case). We will estimate the normal information for the scene below.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// Point clouds</span>
<span class="w">  </span><span class="n">PointCloudT</span><span class="o">::</span><span class="n">Ptr</span><span class="w"> </span><span class="nf">object</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">PointCloudT</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">PointCloudT</span><span class="o">::</span><span class="n">Ptr</span><span class="w"> </span><span class="nf">object_aligned</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">PointCloudT</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">PointCloudT</span><span class="o">::</span><span class="n">Ptr</span><span class="w"> </span><span class="nf">scene_before_downsampling</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">PointCloudT</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">PointCloudT</span><span class="o">::</span><span class="n">Ptr</span><span class="w"> </span><span class="nf">scene</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">PointCloudT</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">FeatureCloudT</span><span class="o">::</span><span class="n">Ptr</span><span class="w"> </span><span class="nf">object_features</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">FeatureCloudT</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">FeatureCloudT</span><span class="o">::</span><span class="n">Ptr</span><span class="w"> </span><span class="nf">scene_features</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">FeatureCloudT</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// Get input object and scene</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_error</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Syntax is: %s object.pcd scene.pcd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// Load object and scene</span>
<span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_highlight</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Loading point clouds...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pcl</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">loadPCDFile</span><span class="o">&lt;</span><span class="n">PointNT</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="o">*</span><span class="n">object</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">      </span><span class="n">pcl</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">loadPCDFile</span><span class="o">&lt;</span><span class="n">PointNT</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="o">*</span><span class="n">scene_before_downsampling</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_error</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Error loading object/scene file!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>To speed up processing, we use PCL’s <a class="reference external" href="https://pointclouds.org/documentation/classpcl_1_1_voxel_grid.html">VoxelGrid</a> class to downsample both the object and the scene point clouds to a resolution of 5 mm.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// Downsample</span>
<span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_highlight</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Downsampling...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">VoxelGrid</span><span class="o">&lt;</span><span class="n">PointNT</span><span class="o">&gt;</span><span class="w"> </span><span class="n">grid</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">leaf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.005f</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">grid</span><span class="p">.</span><span class="n">setLeafSize</span><span class="w"> </span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span><span class="w"> </span><span class="n">leaf</span><span class="p">,</span><span class="w"> </span><span class="n">leaf</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">grid</span><span class="p">.</span><span class="n">setInputCloud</span><span class="w"> </span><span class="p">(</span><span class="n">object</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">grid</span><span class="p">.</span><span class="n">filter</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">object</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">grid</span><span class="p">.</span><span class="n">setInputCloud</span><span class="w"> </span><span class="p">(</span><span class="n">scene_before_downsampling</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">grid</span><span class="p">.</span><span class="n">filter</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">scene</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>The missing surface normals for the scene are now estimated using PCL’s <a class="reference external" href="https://pointclouds.org/documentation/classpcl_1_1_normal_estimation_o_m_p.html">NormalEstimationOMP</a>. The surface normals are required for computing the features below used for matching.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// Estimate normals for scene</span>
<span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_highlight</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Estimating scene normals...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">NormalEstimationOMP</span><span class="o">&lt;</span><span class="n">PointNT</span><span class="p">,</span><span class="n">PointNT</span><span class="o">&gt;</span><span class="w"> </span><span class="n">nest</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">nest</span><span class="p">.</span><span class="n">setRadiusSearch</span><span class="w"> </span><span class="p">(</span><span class="mf">0.005</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">nest</span><span class="p">.</span><span class="n">setInputCloud</span><span class="w"> </span><span class="p">(</span><span class="n">scene</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">nest</span><span class="p">.</span><span class="n">setSearchSurface</span><span class="w"> </span><span class="p">(</span><span class="n">scene_before_downsampling</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">nest</span><span class="p">.</span><span class="n">compute</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">scene</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>For each point in the downsampled point clouds, we now use PCL’s <a class="reference external" href="https://pointclouds.org/documentation/classpcl_1_1_f_p_f_h_estimation_o_m_p.html">FPFHEstimationOMP</a> class to compute <em>Fast Point Feature Histogram</em> (FPFH) descriptors used for matching during the alignment process.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// Estimate features</span>
<span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_highlight</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Estimating features...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">FeatureEstimationT</span><span class="w"> </span><span class="n">fest</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">fest</span><span class="p">.</span><span class="n">setRadiusSearch</span><span class="w"> </span><span class="p">(</span><span class="mf">0.025</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">fest</span><span class="p">.</span><span class="n">setInputCloud</span><span class="w"> </span><span class="p">(</span><span class="n">object</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">fest</span><span class="p">.</span><span class="n">setInputNormals</span><span class="w"> </span><span class="p">(</span><span class="n">object</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">fest</span><span class="p">.</span><span class="n">compute</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">object_features</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">fest</span><span class="p">.</span><span class="n">setInputCloud</span><span class="w"> </span><span class="p">(</span><span class="n">scene</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">fest</span><span class="p">.</span><span class="n">setInputNormals</span><span class="w"> </span><span class="p">(</span><span class="n">scene</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">fest</span><span class="p">.</span><span class="n">compute</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">scene_features</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>We are now ready to setup the alignment process. We use the class <a class="reference external" href="https://pointclouds.org/documentation/classpcl_1_1_sample_consensus_prerejective.html">SampleConsensusPrerejective</a>, which implements an efficient RANSAC pose estimation loop. This is achieved by early elimination of bad pose hypothesis using the class <a class="reference external" href="https://pointclouds.org/documentation/classpcl_1_1registration_1_1_correspondence_rejector_poly.html">CorrespondenceRejectorPoly</a>.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// Perform alignment</span>
<span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_highlight</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Starting alignment...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">SampleConsensusPrerejective</span><span class="o">&lt;</span><span class="n">PointNT</span><span class="p">,</span><span class="n">PointNT</span><span class="p">,</span><span class="n">FeatureT</span><span class="o">&gt;</span><span class="w"> </span><span class="n">align</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">align</span><span class="p">.</span><span class="n">setInputSource</span><span class="w"> </span><span class="p">(</span><span class="n">object</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">align</span><span class="p">.</span><span class="n">setSourceFeatures</span><span class="w"> </span><span class="p">(</span><span class="n">object_features</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">align</span><span class="p">.</span><span class="n">setInputTarget</span><span class="w"> </span><span class="p">(</span><span class="n">scene</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">align</span><span class="p">.</span><span class="n">setTargetFeatures</span><span class="w"> </span><span class="p">(</span><span class="n">scene_features</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">align</span><span class="p">.</span><span class="n">setMaximumIterations</span><span class="w"> </span><span class="p">(</span><span class="mi">50000</span><span class="p">);</span><span class="w"> </span><span class="c1">// Number of RANSAC iterations</span>
<span class="w">  </span><span class="n">align</span><span class="p">.</span><span class="n">setNumberOfSamples</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="p">);</span><span class="w"> </span><span class="c1">// Number of points to sample for generating/prerejecting a pose</span>
<span class="w">  </span><span class="n">align</span><span class="p">.</span><span class="n">setCorrespondenceRandomness</span><span class="w"> </span><span class="p">(</span><span class="mi">5</span><span class="p">);</span><span class="w"> </span><span class="c1">// Number of nearest features to use</span>
<span class="w">  </span><span class="n">align</span><span class="p">.</span><span class="n">setSimilarityThreshold</span><span class="w"> </span><span class="p">(</span><span class="mf">0.95f</span><span class="p">);</span><span class="w"> </span><span class="c1">// Polygonal edge length similarity threshold</span>
<span class="w">  </span><span class="n">align</span><span class="p">.</span><span class="n">setMaxCorrespondenceDistance</span><span class="w"> </span><span class="p">(</span><span class="mf">2.5f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">leaf</span><span class="p">);</span><span class="w"> </span><span class="c1">// Inlier threshold</span>
<span class="w">  </span><span class="n">align</span><span class="p">.</span><span class="n">setInlierFraction</span><span class="w"> </span><span class="p">(</span><span class="mf">0.25f</span><span class="p">);</span><span class="w"> </span><span class="c1">// Required inlier fraction for accepting a pose hypothesis</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Apart from the usual input point clouds and features, this class takes some additional runtime parameters which have great influence on the performance of the alignment algorithm. The first two have the same meaning as in the alignment class <a class="reference external" href="https://pointclouds.org/documentation/classpcl_1_1_sample_consensus_initial_alignment.html">SampleConsensusInitialAlignment</a>:</p>
<ul class="simple">
<li><p>Number of samples - <em>setNumberOfSamples ()</em>: The number of point correspondences to sample between the object and the scene. At minimum, 3 points are required to calculate a pose.</p></li>
<li><p>Correspondence randomness - <em>setCorrespondenceRandomness ()</em>: Instead of matching each object FPFH descriptor to its nearest matching feature in the scene, we can choose between the <em>N</em> best matches at random. This increases the iterations necessary, but also makes the algorithm robust towards outlier matches.</p></li>
<li><p>Polygonal similarity threshold - <em>setSimilarityThreshold ()</em>: The alignment class uses the <a class="reference external" href="https://pointclouds.org/documentation/classpcl_1_1registration_1_1_correspondence_rejector_poly.html">CorrespondenceRejectorPoly</a> class for early elimination of bad poses based on pose-invariant geometric consistencies of the inter-distances between sampled points on the object and the scene. The closer this value is set to 1, the more greedy and thereby fast the algorithm becomes. However, this also increases the risk of eliminating good poses when noise is present.</p></li>
<li><p>Inlier threshold - <em>setMaxCorrespondenceDistance ()</em>: This is the Euclidean distance threshold used for determining whether a transformed object point is correctly aligned to the nearest scene point or not. In this example, we have used a heuristic value of 2.5 times the point cloud resolution.</p></li>
<li><p>Inlier fraction - <em>setInlierFraction ()</em>: In many practical scenarios, large parts of the observed object in the scene are not visible, either due to clutter, occlusions or both. In such cases, we need to allow for pose hypotheses that do not align all object points to the scene. The absolute number of correctly aligned points is determined using the inlier threshold, and if the ratio of this number to the total number of points in the object is higher than the specified inlier fraction, we accept a pose hypothesis as valid.</p></li>
</ul>
</div>
<p>Finally, we are ready to execute the alignment process.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">ScopeTime</span><span class="w"> </span><span class="nf">t</span><span class="p">(</span><span class="s">&quot;Alignment&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">align</span><span class="p">.</span><span class="n">align</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">object_aligned</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The aligned object is stored in the point cloud <em>object_aligned</em>. If a pose with enough inliers was found (more than 25 % of the total number of object points), the algorithm is said to converge, and we can print and visualize the results.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="c1">// Print results</span>
<span class="w">    </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix4f</span><span class="w"> </span><span class="n">transformation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">align</span><span class="p">.</span><span class="n">getFinalTransformation</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_info</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;    | %6.3f %6.3f %6.3f | </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">transformation</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">transformation</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">transformation</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_info</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;R = | %6.3f %6.3f %6.3f | </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">transformation</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">transformation</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">transformation</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_info</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;    | %6.3f %6.3f %6.3f | </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">transformation</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">transformation</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">transformation</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_info</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_info</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;t = &lt; %0.3f, %0.3f, %0.3f &gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">transformation</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="n">transformation</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="n">transformation</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_info</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_info</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Inliers: %i/%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">align</span><span class="p">.</span><span class="n">getInliers</span><span class="w"> </span><span class="p">().</span><span class="n">size</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">object</span><span class="o">-&gt;</span><span class="n">size</span><span class="w"> </span><span class="p">());</span><span class="w"></span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Show alignment</span>
<span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">visualization</span><span class="o">::</span><span class="n">PCLVisualizer</span><span class="w"> </span><span class="nf">visu</span><span class="p">(</span><span class="s">&quot;Alignment&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">visu</span><span class="p">.</span><span class="n">addPointCloud</span><span class="w"> </span><span class="p">(</span><span class="n">scene</span><span class="p">,</span><span class="w"> </span><span class="n">ColorHandlerT</span><span class="w"> </span><span class="p">(</span><span class="n">scene</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">255.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;scene&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">visu</span><span class="p">.</span><span class="n">addPointCloud</span><span class="w"> </span><span class="p">(</span><span class="n">object_aligned</span><span class="p">,</span><span class="w"> </span><span class="n">ColorHandlerT</span><span class="w"> </span><span class="p">(</span><span class="n">object_aligned</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">255.0</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;object_aligned&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">visu</span><span class="p">.</span><span class="n">spin</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="compiling-and-running-the-program">
<h1>Compiling and running the program</h1>
<p>Create a <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> file with the following content (or download it <a class="reference download internal" download="" href="_downloads/b328bb22d9975a40bd72abf6b1b97619/CMakeLists.txt"><code class="xref download docutils literal notranslate"><span class="pre">here</span></code></a>):</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span><span class="w"> </span><span class="s">3.5</span><span class="w"> </span><span class="s">FATAL_ERROR</span><span class="p">)</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="nb">project</span><span class="p">(</span><span class="s">alignment_prerejective</span><span class="p">)</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="nb">find_package</span><span class="p">(</span><span class="s">PCL</span><span class="w"> </span><span class="s">1.7</span><span class="w"> </span><span class="s">REQUIRED</span><span class="w"> </span><span class="s">COMPONENTS</span><span class="w"> </span><span class="s">io</span><span class="w"> </span><span class="s">registration</span><span class="w"> </span><span class="s">segmentation</span><span class="w"> </span><span class="s">visualization</span><span class="p">)</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="nb">include_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">PCL_INCLUDE_DIRS</span><span class="o">}</span><span class="p">)</span>
<span class="linenos"> 8</span><span class="nb">link_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">PCL_LIBRARY_DIRS</span><span class="o">}</span><span class="p">)</span>
<span class="linenos"> 9</span><span class="nb">add_definitions</span><span class="p">(</span><span class="o">${</span><span class="nv">PCL_DEFINITIONS</span><span class="o">}</span><span class="p">)</span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="nb">add_executable</span> <span class="p">(</span><span class="s">alignment_prerejective</span><span class="w"> </span><span class="s">alignment_prerejective.cpp</span><span class="p">)</span>
<span class="linenos">12</span><span class="nb">target_link_libraries</span> <span class="p">(</span><span class="s">alignment_prerejective</span><span class="w"> </span><span class="o">${</span><span class="nv">PCL_LIBRARIES</span><span class="o">}</span><span class="p">)</span>
</pre></div>
</div>
<p>After you have made the executable, you can run it like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ./alignment_prerejective chef.pcd rs1.pcd
</pre></div>
</div>
<p>After a few seconds, you will see a visualization and a terminal output similar to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Alignment</span> <span class="n">took</span> <span class="mi">352</span><span class="n">ms</span><span class="o">.</span>

    <span class="o">|</span>  <span class="mf">0.040</span> <span class="o">-</span><span class="mf">0.929</span> <span class="o">-</span><span class="mf">0.369</span> <span class="o">|</span>
<span class="n">R</span> <span class="o">=</span> <span class="o">|</span> <span class="o">-</span><span class="mf">0.999</span> <span class="o">-</span><span class="mf">0.035</span> <span class="o">-</span><span class="mf">0.020</span> <span class="o">|</span>
    <span class="o">|</span>  <span class="mf">0.006</span>  <span class="mf">0.369</span> <span class="o">-</span><span class="mf">0.929</span> <span class="o">|</span>

<span class="n">t</span> <span class="o">=</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.120</span><span class="p">,</span> <span class="mf">0.055</span><span class="p">,</span> <span class="mf">0.076</span> <span class="o">&gt;</span>

<span class="n">Inliers</span><span class="p">:</span> <span class="mi">1422</span><span class="o">/</span><span class="mi">3432</span>
</pre></div>
</div>
<p>The visualization window should look something like the below figures. The scene is shown with green color, and the aligned object model is shown with blue color. Note the high number of non-visible object points.</p>
<figure class="align-center" id="id1">
<a class="reference internal image-reference" href="_images/alignment_prerejective_1.png"><img alt="_images/alignment_prerejective_1.png" src="_images/alignment_prerejective_1.png" style="width: 600.0px; height: 337.5px;" /></a>
<figcaption>
<p><span class="caption-text"><em>Frontal view</em></span></p>
</figcaption>
</figure>
<div class="line-block">
<div class="line"><br /></div>
</div>
<figure class="align-center" id="id2">
<a class="reference internal image-reference" href="_images/alignment_prerejective_2.png"><img alt="_images/alignment_prerejective_2.png" src="_images/alignment_prerejective_2.png" style="width: 600.0px; height: 337.5px;" /></a>
<figcaption>
<p><span class="caption-text"><em>Side view</em></span></p>
</figcaption>
</figure>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>