<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cluster Recognition and 6DOF Pose Estimation using VFH descriptors &mdash; Point Cloud Library 1.14.1-dev documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> Point Cloud Library
          </a>
              <div class="version">
                1.14.1-dev
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">Cluster Recognition and 6DOF Pose Estimation using VFH descriptors</a></li>
<li><a class="reference internal" href="#training">Training</a></li>
<li><a class="reference internal" href="#testing">Testing</a></li>
<li><a class="reference internal" href="#compiling-and-running-the-code">Compiling and running the code</a></li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Point Cloud Library</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Cluster Recognition and 6DOF Pose Estimation using VFH descriptors</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="cluster-recognition-and-6dof-pose-estimation-using-vfh-descriptors">
<span id="vfh-recognition"></span><h1>Cluster Recognition and 6DOF Pose Estimation using VFH descriptors</h1>
<p>As previously described in <a class="reference internal" href="vfh_estimation.html#vfh-estimation"><span class="std std-ref">Estimating VFH signatures for a set of points</span></a>, Viewpoint Feature Histograms
(VFH) are powerful <em>meta-local</em> descriptors, created for the purpose of
recognition and pose estimation for <strong>clusters</strong> of points. We here refer to a
<strong>cluster</strong> as a collection of 3D points, most of the time representing a
particular object or part of a scene, obtained through some segmentation or
detection mechanisms (please see <a class="reference internal" href="cluster_extraction.html#cluster-extraction"><span class="std std-ref">Euclidean Cluster Extraction</span></a> for an example).</p>
<p>Our goal here is not to provide an ultimate recognition tool, but rather a
mechanism for obtaining <strong>candidates</strong> that <em>could potentially be the
cluster/object that is searched for</em>, together with its 6DOF pose in space.
With this in mind, we will be formulating the <em>recognition</em> problem as a
<em>nearest neighbor estimation</em> problem. So given a set of <em>training data</em>, we
will use efficient nearest neighbor search structures such as <em>kd-trees</em> and
return a set of potential candidates with sorted distances to the query object,
rather than an absolute <em>“this is the object that we were searching for”</em> kind
of response. The reader can imagine that such a system becomes much more useful
as we can explicitly reason about failures (false positives, or true
negatives).</p>
<p>For the purpose of this tutorial, the application example could be formulated as follows:</p>
<blockquote>
<div><ul class="simple">
<li><p>Training stage:</p>
<ul>
<li><p>given a scene with 1 object that is easily separable as a cluster;</p></li>
<li><p>use a ground-truth system to obtain its pose (see the discussion below);</p></li>
<li><p>rotate around the object or rotate the object with respect to the camera, and compute a VFH descriptor for each view;</p></li>
<li><p>store the views, and build a kd-tree representation.</p></li>
</ul>
</li>
<li><p>Testing stage:</p>
<ul>
<li><p>given a scene with objects that can be separated as individual clusters, first extract the clusters;</p></li>
<li><p>for each cluster, compute a VFH descriptor from the current camera position;</p></li>
<li><p>use the VFH descriptor to search for candidates in the trained kd-tree.</p></li>
</ul>
</li>
</ul>
</div></blockquote>
<p>We hope the above makes sense. Basically we’re first going to create the set of
objects that we try to later on recognize, and then we will use that to obtain
valid candidates for objects in the scene.</p>
<p>A good example of a ground-truth system could be a simple rotating pan-tilt
unit such as the one in the figure below. Placing an object on the unit, and
moving it with some increments in both horizontal and vertical, can result in a
perfect ground-truth system for small objects. A cheaper solution could be to
use a marker-based system (e.g., checkerboard) and rotate the camera/table
manually.</p>
<img alt="_images/pan_tilt.jpg" class="align-center" src="_images/pan_tilt.jpg" />
<p>Our Kd-Tree implementation of choice for the purpose of this tutorial is of
course, <a class="reference external" href="http://www.cs.ubc.ca/research/flann/">FLANN</a>.</p>
</section>
<section id="training">
<h1>Training</h1>
<p>We begin the training by assuming that the <em>objects</em> are already separated as
individual clusters (see <a class="reference internal" href="cluster_extraction.html#cluster-extraction"><span class="std std-ref">Euclidean Cluster Extraction</span></a>), as shown in the figure
below:</p>
<img alt="_images/scene_raw.jpg" src="_images/scene_raw.jpg" />
<img alt="_images/scene_segmented.jpg" src="_images/scene_segmented.jpg" />
<p>Since we’re only trying to cover the explicit training/testing of VFH
signatures in this tutorial, we provide a set of datasets already collected at:
<a class="reference external" href="https://raw.github.com/PointCloudLibrary/data/master/tutorials/vfh_recognition/vfh_recognition_tutorial_data.tbz">vfh_recognition_tutorial_data.tbz</a>.
The data is a subset of the objects presented in the figure below (left), and
look like the point clouds on the right. We used the pan-tilt table shown above
to acquire the data.</p>
<img alt="_images/objects.jpg" src="_images/objects.jpg" />
<img alt="_images/training.jpg" src="_images/training.jpg" />
<p>Next, copy and paste the following code into your editor and save it as
<code class="docutils literal notranslate"><span class="pre">build_tree.cpp</span></code>.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/point_types.h&gt;</span><span class="cp"></span>
<span class="linenos">  2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/point_cloud.h&gt;</span><span class="cp"></span>
<span class="linenos">  3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/common/pcl_filesystem.h&gt;</span><span class="cp"></span>
<span class="linenos">  4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/console/print.h&gt;</span><span class="cp"></span>
<span class="linenos">  5</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/io/pcd_io.h&gt;</span><span class="cp"></span>
<span class="linenos">  6</span>
<span class="linenos">  7</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;flann/flann.h&gt;</span><span class="cp"></span>
<span class="linenos">  8</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;flann/io/hdf5.h&gt;</span><span class="cp"></span>
<span class="linenos">  9</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;fstream&gt;</span><span class="cp"></span>
<span class="linenos"> 10</span>
<span class="linenos"> 11</span>
<span class="linenos"> 12</span><span class="k">typedef</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vfh_model</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 13</span>
<span class="linenos"> 14</span><span class="cm">/** \brief Loads an n-D histogram file as a VFH signature</span>
<span class="linenos"> 15</span><span class="cm">  * \param path the input file name</span>
<span class="linenos"> 16</span><span class="cm">  * \param vfh the resultant VFH model</span>
<span class="linenos"> 17</span><span class="cm">  */</span><span class="w"></span>
<span class="linenos"> 18</span><span class="kt">bool</span><span class="w"></span>
<span class="linenos"> 19</span><span class="nf">loadHist</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">pcl_fs</span><span class="o">::</span><span class="n">path</span><span class="w"> </span><span class="o">&amp;</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">vfh_model</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vfh</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 20</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 21</span><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">vfh_idx</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 22</span><span class="w">  </span><span class="c1">// Load the file as a PCD</span>
<span class="linenos"> 23</span><span class="w">  </span><span class="k">try</span><span class="w"></span>
<span class="linenos"> 24</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 25</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">PCLPointCloud2</span><span class="w"> </span><span class="n">cloud</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 26</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">version</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 27</span><span class="w">    </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector4f</span><span class="w"> </span><span class="n">origin</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 28</span><span class="w">    </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Quaternionf</span><span class="w"> </span><span class="n">orientation</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 29</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">PCDReader</span><span class="w"> </span><span class="n">r</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 30</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">type</span><span class="p">;</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 31</span><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="n">readHeader</span><span class="w"> </span><span class="p">(</span><span class="n">path</span><span class="p">.</span><span class="n">string</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">cloud</span><span class="p">,</span><span class="w"> </span><span class="n">origin</span><span class="p">,</span><span class="w"> </span><span class="n">orientation</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 32</span>
<span class="linenos"> 33</span><span class="w">    </span><span class="n">vfh_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">getFieldIndex</span><span class="w"> </span><span class="p">(</span><span class="n">cloud</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;vfh&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 34</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vfh_idx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 35</span><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 36</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">cloud</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cloud</span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 37</span><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 38</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 39</span><span class="w">  </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">InvalidConversionException</span><span class="o">&amp;</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 40</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 41</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 42</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 43</span>
<span class="linenos"> 44</span><span class="w">  </span><span class="c1">// Treat the VFH signature as a single Point Cloud</span>
<span class="linenos"> 45</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="w"> </span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">VFHSignature308</span><span class="o">&gt;</span><span class="w"> </span><span class="n">point</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 46</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">loadPCDFile</span><span class="w"> </span><span class="p">(</span><span class="n">path</span><span class="p">.</span><span class="n">string</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">point</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 47</span><span class="w">  </span><span class="n">vfh</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">resize</span><span class="w"> </span><span class="p">(</span><span class="mi">308</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 48</span>
<span class="linenos"> 49</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="w"> </span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PCLPointField</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fields</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 50</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">getFieldIndex</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">VFHSignature308</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;vfh&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fields</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 51</span>
<span class="linenos"> 52</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">fields</span><span class="p">[</span><span class="n">vfh_idx</span><span class="p">].</span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 53</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 54</span><span class="w">    </span><span class="n">vfh</span><span class="p">.</span><span class="n">second</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">histogram</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="linenos"> 55</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 56</span><span class="w">  </span><span class="n">vfh</span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path</span><span class="p">.</span><span class="n">string</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="linenos"> 57</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 58</span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 59</span>
<span class="linenos"> 60</span><span class="cm">/** \brief Load a set of VFH features that will act as the model (training data)</span>
<span class="linenos"> 61</span><span class="cm">  * \param argc the number of arguments (pass from main ())</span>
<span class="linenos"> 62</span><span class="cm">  * \param argv the actual command line arguments (pass from main ())</span>
<span class="linenos"> 63</span><span class="cm">  * \param extension the file extension containing the VFH features</span>
<span class="linenos"> 64</span><span class="cm">  * \param models the resultant vector of histogram models</span>
<span class="linenos"> 65</span><span class="cm">  */</span><span class="w"></span>
<span class="linenos"> 66</span><span class="kt">void</span><span class="w"></span>
<span class="linenos"> 67</span><span class="nf">loadFeatureModels</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">pcl_fs</span><span class="o">::</span><span class="n">path</span><span class="w"> </span><span class="o">&amp;</span><span class="n">base_dir</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">extension</span><span class="p">,</span><span class="w"> </span>
<span class="linenos"> 68</span><span class="w">                   </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">vfh_model</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">models</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 69</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 70</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pcl_fs</span><span class="o">::</span><span class="n">exists</span><span class="w"> </span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">pcl_fs</span><span class="o">::</span><span class="n">is_directory</span><span class="w"> </span><span class="p">(</span><span class="n">base_dir</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 71</span><span class="w">    </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 72</span>
<span class="linenos"> 73</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">pcl_fs</span><span class="o">::</span><span class="n">directory_iterator</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="p">(</span><span class="n">base_dir</span><span class="p">);</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">pcl_fs</span><span class="o">::</span><span class="n">directory_iterator</span><span class="w"> </span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">it</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 74</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 75</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pcl_fs</span><span class="o">::</span><span class="n">is_directory</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">status</span><span class="w"> </span><span class="p">()))</span><span class="w"></span>
<span class="linenos"> 76</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 77</span><span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">stringstream</span><span class="w"> </span><span class="n">ss</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 78</span><span class="w">      </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">path</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="linenos"> 79</span><span class="w">      </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_highlight</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Loading %s (%lu models loaded so far).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="w"> </span><span class="p">().</span><span class="n">c_str</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">models</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="p">());</span><span class="w"></span>
<span class="linenos"> 80</span><span class="w">      </span><span class="n">loadFeatureModels</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">path</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">extension</span><span class="p">,</span><span class="w"> </span><span class="n">models</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 81</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 82</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pcl_fs</span><span class="o">::</span><span class="n">is_regular_file</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">status</span><span class="w"> </span><span class="p">())</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">path</span><span class="w"> </span><span class="p">().</span><span class="n">extension</span><span class="w"> </span><span class="p">().</span><span class="n">string</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">extension</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 83</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 84</span><span class="w">      </span><span class="n">vfh_model</span><span class="w"> </span><span class="n">m</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 85</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">loadHist</span><span class="w"> </span><span class="p">(</span><span class="n">base_dir</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">path</span><span class="w"> </span><span class="p">().</span><span class="n">filename</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">m</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 86</span><span class="w">        </span><span class="n">models</span><span class="p">.</span><span class="n">push_back</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 87</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 88</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 89</span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 90</span>
<span class="linenos"> 91</span><span class="kt">int</span><span class="w"></span>
<span class="linenos"> 92</span><span class="nf">main</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 93</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 94</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 95</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 96</span><span class="w">    </span><span class="n">PCL_ERROR</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Need at least two parameters! Syntax is: %s [model_directory] [options]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="linenos"> 97</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 98</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 99</span>
<span class="linenos">100</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">extension</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;.pcd&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">101</span><span class="w">  </span><span class="n">transform</span><span class="w"> </span><span class="p">(</span><span class="n">extension</span><span class="p">.</span><span class="n">begin</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">extension</span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">extension</span><span class="p">.</span><span class="n">begin</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">int</span><span class="p">))</span><span class="n">tolower</span><span class="p">);</span><span class="w"></span>
<span class="linenos">102</span>
<span class="linenos">103</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">kdtree_idx_file_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;kdtree.idx&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">104</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">training_data_h5_file_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;training_data.h5&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">105</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">training_data_list_file_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;training_data.list&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">106</span>
<span class="linenos">107</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">vfh_model</span><span class="o">&gt;</span><span class="w"> </span><span class="n">models</span><span class="p">;</span><span class="w"></span>
<span class="linenos">108</span>
<span class="linenos">109</span><span class="w">  </span><span class="c1">// Load the model histograms</span>
<span class="linenos">110</span><span class="w">  </span><span class="n">loadFeatureModels</span><span class="w"> </span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">extension</span><span class="p">,</span><span class="w"> </span><span class="n">models</span><span class="p">);</span><span class="w"></span>
<span class="linenos">111</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_highlight</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Loaded %d VFH models. Creating training data %s/%s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="linenos">112</span><span class="w">      </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">models</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">training_data_h5_file_name</span><span class="p">.</span><span class="n">c_str</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">training_data_list_file_name</span><span class="p">.</span><span class="n">c_str</span><span class="w"> </span><span class="p">());</span><span class="w"></span>
<span class="linenos">113</span>
<span class="linenos">114</span><span class="w">  </span><span class="c1">// Convert data into FLANN format</span>
<span class="linenos">115</span><span class="w">  </span><span class="n">flann</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">models</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">second</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="p">()],</span><span class="w"> </span><span class="n">models</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">second</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="p">());</span><span class="w"></span>
<span class="linenos">116</span>
<span class="linenos">117</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">rows</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="linenos">118</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">cols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">j</span><span class="p">)</span><span class="w"></span>
<span class="linenos">119</span><span class="w">      </span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">second</span><span class="p">[</span><span class="n">j</span><span class="p">];</span><span class="w"></span>
<span class="linenos">120</span>
<span class="linenos">121</span><span class="w">  </span><span class="c1">// Save data to disk (list of models)</span>
<span class="linenos">122</span><span class="w">  </span><span class="n">flann</span><span class="o">::</span><span class="n">save_to_file</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">training_data_h5_file_name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;training_data&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">123</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">ofstream</span><span class="w"> </span><span class="n">fs</span><span class="p">;</span><span class="w"></span>
<span class="linenos">124</span><span class="w">  </span><span class="n">fs</span><span class="p">.</span><span class="n">open</span><span class="w"> </span><span class="p">(</span><span class="n">training_data_list_file_name</span><span class="p">.</span><span class="n">c_str</span><span class="w"> </span><span class="p">());</span><span class="w"></span>
<span class="linenos">125</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">models</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="linenos">126</span><span class="w">    </span><span class="n">fs</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">first</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">127</span><span class="w">  </span><span class="n">fs</span><span class="p">.</span><span class="n">close</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="linenos">128</span><span class="w"> </span>
<span class="linenos">129</span><span class="w">  </span><span class="c1">// Build the tree index and save it to disk</span>
<span class="linenos">130</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_error</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Building the kdtree index (%s) for %d elements...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">kdtree_idx_file_name</span><span class="p">.</span><span class="n">c_str</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">data</span><span class="p">.</span><span class="n">rows</span><span class="p">);</span><span class="w"></span>
<span class="linenos">131</span><span class="w">  </span><span class="n">flann</span><span class="o">::</span><span class="n">Index</span><span class="o">&lt;</span><span class="n">flann</span><span class="o">::</span><span class="n">ChiSquareDistance</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">flann</span><span class="o">::</span><span class="n">LinearIndexParams</span><span class="w"> </span><span class="p">());</span><span class="w"></span>
<span class="linenos">132</span><span class="w">  </span><span class="c1">//flann::Index&lt;flann::ChiSquareDistance&lt;float&gt; &gt; index (data, flann::KDTreeIndexParams (4));</span>
<span class="linenos">133</span><span class="w">  </span><span class="n">index</span><span class="p">.</span><span class="n">buildIndex</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="linenos">134</span><span class="w">  </span><span class="n">index</span><span class="p">.</span><span class="n">save</span><span class="w"> </span><span class="p">(</span><span class="n">kdtree_idx_file_name</span><span class="p">);</span><span class="w"></span>
<span class="linenos">135</span><span class="w">  </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">ptr</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="linenos">136</span>
<span class="linenos">137</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="linenos">138</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>In the following paragraphs we will explain what the above code does (or should
do). We’ll begin with the <code class="docutils literal notranslate"><span class="pre">main</span></code> function.</p>
<p>We begin by loading a set of feature models from a directory given as the first
command line argument (see details for running the example below). The
<code class="docutils literal notranslate"><span class="pre">loadFeatureModels</span></code> method does nothing but recursively traverse a set of
directories and subdirectories, and loads in all <em>.PCD</em> files it finds. In
<code class="docutils literal notranslate"><span class="pre">loadFeatureModels</span></code>, we call <code class="docutils literal notranslate"><span class="pre">loadHist</span></code>, which will attempt to open each
PCD file found, read its header, and check whether it contains a VFH signature
or not. Together with the VFH signature we also store the PCD file name into a
<code class="docutils literal notranslate"><span class="pre">vfh_model</span></code> pair.</p>
<p>Once all VFH features have been loaded, we convert them to FLANN format, using:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// Convert data into FLANN format</span>
<span class="w">  </span><span class="n">flann</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">models</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">second</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="p">()],</span><span class="w"> </span><span class="n">models</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">second</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="p">());</span><span class="w"></span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">rows</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">cols</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">j</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">second</span><span class="p">[</span><span class="n">j</span><span class="p">];</span><span class="w"></span>
</pre></div>
</div>
<p>Since we’re lazy, and we want to use this data (and not reload it again by crawling the directory structure in the testing phase), we dump the data to disk:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// Save data to disk (list of models)</span>
<span class="w">  </span><span class="n">flann</span><span class="o">::</span><span class="n">save_to_file</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">training_data_h5_file_name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;training_data&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">ofstream</span><span class="w"> </span><span class="n">fs</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">fs</span><span class="p">.</span><span class="n">open</span><span class="w"> </span><span class="p">(</span><span class="n">training_data_list_file_name</span><span class="p">.</span><span class="n">c_str</span><span class="w"> </span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">models</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">fs</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">first</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">fs</span><span class="p">.</span><span class="n">close</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
</pre></div>
</div>
<p>Finally, we create the KdTree, and save its structure to disk:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_error</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Building the kdtree index (%s) for %d elements...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">kdtree_idx_file_name</span><span class="p">.</span><span class="n">c_str</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">data</span><span class="p">.</span><span class="n">rows</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">flann</span><span class="o">::</span><span class="n">Index</span><span class="o">&lt;</span><span class="n">flann</span><span class="o">::</span><span class="n">ChiSquareDistance</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">flann</span><span class="o">::</span><span class="n">LinearIndexParams</span><span class="w"> </span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="c1">//flann::Index&lt;flann::ChiSquareDistance&lt;float&gt; &gt; index (data, flann::KDTreeIndexParams (4));</span>
<span class="w">  </span><span class="n">index</span><span class="p">.</span><span class="n">buildIndex</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">index</span><span class="p">.</span><span class="n">save</span><span class="w"> </span><span class="p">(</span><span class="n">kdtree_idx_file_name</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Here we will use a <code class="docutils literal notranslate"><span class="pre">LinearIndex</span></code>, which does a brute-force search using a
Chi-Square distance metric (see <a class="reference internal" href="vfh_estimation.html#vfh" id="id1"><span>[VFH]</span></a> for more information). For building a
proper kd-tree, comment line 1 and uncomment line 2 in the code snippet above.
The most important difference between a LinearIndex and a KDTreeIndex in FLANN
is that the KDTree will be much faster, while producing approximate nearest
neighbor results, rather than absolute.</p>
<p>So, we’re done with training. To summarize:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>we crawled a directory structure, looked at all the .PCD files we found, tested them whether they are VFH signatures and loaded them in memory;</p></li>
<li><p>we converted the data into FLANN format and dumped it to disk;</p></li>
<li><p>we built a kd-tree structure and dumped it to disk.</p></li>
</ol>
</div></blockquote>
</section>
<section id="testing">
<h1>Testing</h1>
<p>In the testing phase, we will illustrate how the system works by randomly
loading one of the files used in the training phase (feel free to supply your
own file here!), and checking the results of the tree.</p>
<p>Begin by copying and pasting the following code into your editor and save it as
<code class="docutils literal notranslate"><span class="pre">nearest_neighbors.cpp</span></code>.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/point_types.h&gt;</span><span class="cp"></span>
<span class="linenos">  2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/point_cloud.h&gt;</span><span class="cp"></span>
<span class="linenos">  3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/common/common.h&gt;</span><span class="cp"></span>
<span class="linenos">  4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/common/centroid.h&gt;</span><span class="c1"> // for compute3DCentroid</span><span class="cp"></span>
<span class="linenos">  5</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/visualization/pcl_visualizer.h&gt;</span><span class="cp"></span>
<span class="linenos">  6</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/common/pcl_filesystem.h&gt;</span><span class="cp"></span>
<span class="linenos">  7</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/console/parse.h&gt;</span><span class="cp"></span>
<span class="linenos">  8</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/console/print.h&gt;</span><span class="cp"></span>
<span class="linenos">  9</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/io/pcd_io.h&gt;</span><span class="cp"></span>
<span class="linenos"> 10</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="linenos"> 11</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;limits&gt;</span><span class="cp"></span>
<span class="linenos"> 12</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;flann/flann.h&gt;</span><span class="cp"></span>
<span class="linenos"> 13</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;flann/io/hdf5.h&gt;</span><span class="cp"></span>
<span class="linenos"> 14</span>
<span class="linenos"> 15</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;boost/algorithm/string/replace.hpp&gt;</span><span class="c1"> // for replace_last</span><span class="cp"></span>
<span class="linenos"> 16</span><span class="k">typedef</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">vfh_model</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 17</span>
<span class="linenos"> 18</span><span class="cm">/** \brief Loads an n-D histogram file as a VFH signature</span>
<span class="linenos"> 19</span><span class="cm">  * \param path the input file name</span>
<span class="linenos"> 20</span><span class="cm">  * \param vfh the resultant VFH model</span>
<span class="linenos"> 21</span><span class="cm">  */</span><span class="w"></span>
<span class="linenos"> 22</span><span class="kt">bool</span><span class="w"></span>
<span class="linenos"> 23</span><span class="nf">loadHist</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">pcl_fs</span><span class="o">::</span><span class="n">path</span><span class="w"> </span><span class="o">&amp;</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">vfh_model</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vfh</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 24</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 25</span><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">vfh_idx</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 26</span><span class="w">  </span><span class="c1">// Load the file as a PCD</span>
<span class="linenos"> 27</span><span class="w">  </span><span class="k">try</span><span class="w"></span>
<span class="linenos"> 28</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 29</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">PCLPointCloud2</span><span class="w"> </span><span class="n">cloud</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 30</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">version</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 31</span><span class="w">    </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector4f</span><span class="w"> </span><span class="n">origin</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 32</span><span class="w">    </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Quaternionf</span><span class="w"> </span><span class="n">orientation</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 33</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">PCDReader</span><span class="w"> </span><span class="n">r</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 34</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">type</span><span class="p">;</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 35</span><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="n">readHeader</span><span class="w"> </span><span class="p">(</span><span class="n">path</span><span class="p">.</span><span class="n">string</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">cloud</span><span class="p">,</span><span class="w"> </span><span class="n">origin</span><span class="p">,</span><span class="w"> </span><span class="n">orientation</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 36</span>
<span class="linenos"> 37</span><span class="w">    </span><span class="n">vfh_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">getFieldIndex</span><span class="w"> </span><span class="p">(</span><span class="n">cloud</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;vfh&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 38</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vfh_idx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 39</span><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 40</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">cloud</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cloud</span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 41</span><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 42</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 43</span><span class="w">  </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">InvalidConversionException</span><span class="o">&amp;</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 44</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 45</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 46</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 47</span>
<span class="linenos"> 48</span><span class="w">  </span><span class="c1">// Treat the VFH signature as a single Point Cloud</span>
<span class="linenos"> 49</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="w"> </span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">VFHSignature308</span><span class="o">&gt;</span><span class="w"> </span><span class="n">point</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 50</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">loadPCDFile</span><span class="w"> </span><span class="p">(</span><span class="n">path</span><span class="p">.</span><span class="n">string</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">point</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 51</span><span class="w">  </span><span class="n">vfh</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">resize</span><span class="w"> </span><span class="p">(</span><span class="mi">308</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 52</span>
<span class="linenos"> 53</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="w"> </span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PCLPointField</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fields</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 54</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">getFieldIndex</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">VFHSignature308</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;vfh&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fields</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 55</span>
<span class="linenos"> 56</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">fields</span><span class="p">[</span><span class="n">vfh_idx</span><span class="p">].</span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 57</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 58</span><span class="w">    </span><span class="n">vfh</span><span class="p">.</span><span class="n">second</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">histogram</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="linenos"> 59</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 60</span><span class="w">  </span><span class="n">vfh</span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path</span><span class="p">.</span><span class="n">string</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="linenos"> 61</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 62</span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 63</span>
<span class="linenos"> 64</span>
<span class="linenos"> 65</span><span class="cm">/** \brief Search for the closest k neighbors</span>
<span class="linenos"> 66</span><span class="cm">  * \param index the tree</span>
<span class="linenos"> 67</span><span class="cm">  * \param model the query model</span>
<span class="linenos"> 68</span><span class="cm">  * \param k the number of neighbors to search for</span>
<span class="linenos"> 69</span><span class="cm">  * \param indices the resultant neighbor indices</span>
<span class="linenos"> 70</span><span class="cm">  * \param distances the resultant neighbor distances</span>
<span class="linenos"> 71</span><span class="cm">  */</span><span class="w"></span>
<span class="linenos"> 72</span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"></span>
<span class="linenos"> 73</span><span class="nf">nearestKSearch</span><span class="w"> </span><span class="p">(</span><span class="n">flann</span><span class="o">::</span><span class="n">Index</span><span class="o">&lt;</span><span class="n">flann</span><span class="o">::</span><span class="n">ChiSquareDistance</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">vfh_model</span><span class="w"> </span><span class="o">&amp;</span><span class="n">model</span><span class="p">,</span><span class="w"> </span>
<span class="linenos"> 74</span><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">flann</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">indices</span><span class="p">,</span><span class="w"> </span><span class="n">flann</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">distances</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 75</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 76</span><span class="w">  </span><span class="c1">// Query point</span>
<span class="linenos"> 77</span><span class="w">  </span><span class="n">flann</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flann</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">model</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="p">()],</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="p">());</span><span class="w"></span>
<span class="linenos"> 78</span><span class="w">  </span><span class="n">memcpy</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">.</span><span class="n">ptr</span><span class="w"> </span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">model</span><span class="p">.</span><span class="n">second</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">cols</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">rows</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">));</span><span class="w"></span>
<span class="linenos"> 79</span>
<span class="linenos"> 80</span><span class="w">  </span><span class="n">indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flann</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 81</span><span class="w">  </span><span class="n">distances</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flann</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 82</span><span class="w">  </span><span class="n">index</span><span class="p">.</span><span class="n">knnSearch</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">indices</span><span class="p">,</span><span class="w"> </span><span class="n">distances</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">flann</span><span class="o">::</span><span class="n">SearchParams</span><span class="w"> </span><span class="p">(</span><span class="mi">512</span><span class="p">));</span><span class="w"></span>
<span class="linenos"> 83</span><span class="w">  </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">ptr</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="linenos"> 84</span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 85</span>
<span class="linenos"> 86</span><span class="cm">/** \brief Load the list of file model names from an ASCII file</span>
<span class="linenos"> 87</span><span class="cm">  * \param models the resultant list of model name</span>
<span class="linenos"> 88</span><span class="cm">  * \param filename the input file name</span>
<span class="linenos"> 89</span><span class="cm">  */</span><span class="w"></span>
<span class="linenos"> 90</span><span class="kt">bool</span><span class="w"></span>
<span class="linenos"> 91</span><span class="nf">loadFileList</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">vfh_model</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">models</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">filename</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 92</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 93</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">ifstream</span><span class="w"> </span><span class="n">fs</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 94</span><span class="w">  </span><span class="n">fs</span><span class="p">.</span><span class="n">open</span><span class="w"> </span><span class="p">(</span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="w"> </span><span class="p">());</span><span class="w"></span>
<span class="linenos"> 95</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">fs</span><span class="p">.</span><span class="n">is_open</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">fs</span><span class="p">.</span><span class="n">fail</span><span class="w"> </span><span class="p">())</span><span class="w"></span>
<span class="linenos"> 96</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 97</span>
<span class="linenos"> 98</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">line</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 99</span><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">fs</span><span class="p">.</span><span class="n">eof</span><span class="w"> </span><span class="p">())</span><span class="w"></span>
<span class="linenos">100</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos">101</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">getline</span><span class="w"> </span><span class="p">(</span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="p">);</span><span class="w"></span>
<span class="linenos">102</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="n">empty</span><span class="w"> </span><span class="p">())</span><span class="w"></span>
<span class="linenos">103</span><span class="w">      </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="linenos">104</span><span class="w">    </span><span class="n">vfh_model</span><span class="w"> </span><span class="n">m</span><span class="p">;</span><span class="w"></span>
<span class="linenos">105</span><span class="w">    </span><span class="n">m</span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">line</span><span class="p">;</span><span class="w"></span>
<span class="linenos">106</span><span class="w">    </span><span class="n">models</span><span class="p">.</span><span class="n">push_back</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="p">);</span><span class="w"></span>
<span class="linenos">107</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">108</span><span class="w">  </span><span class="n">fs</span><span class="p">.</span><span class="n">close</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="linenos">109</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="linenos">110</span><span class="p">}</span><span class="w"></span>
<span class="linenos">111</span>
<span class="linenos">112</span><span class="kt">int</span><span class="w"></span>
<span class="linenos">113</span><span class="nf">main</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span><span class="w"></span>
<span class="linenos">114</span><span class="p">{</span><span class="w"></span>
<span class="linenos">115</span><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w"></span>
<span class="linenos">116</span>
<span class="linenos">117</span><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">thresh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">();</span><span class="w">     </span><span class="c1">// No threshold, disabled by default</span>
<span class="linenos">118</span>
<span class="linenos">119</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">120</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos">121</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_error</span><span class="w"> </span>
<span class="linenos">122</span><span class="w">      </span><span class="p">(</span><span class="s">&quot;Need at least three parameters! Syntax is: %s &lt;query_vfh_model.pcd&gt; [options] {kdtree.idx} {training_data.h5} {training_data.list}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="linenos">123</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_info</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;    where [options] are:  -k      = number of nearest neighbors to search for in the tree (default: &quot;</span><span class="p">);</span><span class="w"> </span>
<span class="linenos">124</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_value</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">);</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_info</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">125</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_info</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;                          -thresh = maximum distance threshold for a model to be considered VALID (default: &quot;</span><span class="p">);</span><span class="w"> </span>
<span class="linenos">126</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_value</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;%f&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">thresh</span><span class="p">);</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_info</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;)</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">127</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">128</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">129</span>
<span class="linenos">130</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">extension</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;.pcd&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">131</span><span class="w">  </span><span class="n">transform</span><span class="w"> </span><span class="p">(</span><span class="n">extension</span><span class="p">.</span><span class="n">begin</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">extension</span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">extension</span><span class="p">.</span><span class="n">begin</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">int</span><span class="p">))</span><span class="n">tolower</span><span class="p">);</span><span class="w"></span>
<span class="linenos">132</span>
<span class="linenos">133</span><span class="w">  </span><span class="c1">// Load the test histogram</span>
<span class="linenos">134</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pcd_indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">parse_file_extension_argument</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;.pcd&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">135</span><span class="w">  </span><span class="n">vfh_model</span><span class="w"> </span><span class="n">histogram</span><span class="p">;</span><span class="w"></span>
<span class="linenos">136</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">loadHist</span><span class="w"> </span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">pcd_indices</span><span class="p">.</span><span class="n">at</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">)],</span><span class="w"> </span><span class="n">histogram</span><span class="p">))</span><span class="w"></span>
<span class="linenos">137</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos">138</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_error</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Cannot load test file %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="n">pcd_indices</span><span class="p">.</span><span class="n">at</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">)]);</span><span class="w"></span>
<span class="linenos">139</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">140</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">141</span>
<span class="linenos">142</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">parse_argument</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-thresh&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">thresh</span><span class="p">);</span><span class="w"></span>
<span class="linenos">143</span><span class="w">  </span><span class="c1">// Search for the k closest matches</span>
<span class="linenos">144</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">parse_argument</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-k&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">);</span><span class="w"></span>
<span class="linenos">145</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_highlight</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Using &quot;</span><span class="p">);</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_value</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">);</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_info</span><span class="w"> </span><span class="p">(</span><span class="s">&quot; nearest neighbors.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">146</span>
<span class="linenos">147</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">kdtree_idx_file_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;kdtree.idx&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">148</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">training_data_h5_file_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;training_data.h5&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">149</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">training_data_list_file_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;training_data.list&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">150</span>
<span class="linenos">151</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">vfh_model</span><span class="o">&gt;</span><span class="w"> </span><span class="n">models</span><span class="p">;</span><span class="w"></span>
<span class="linenos">152</span><span class="w">  </span><span class="n">flann</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">k_indices</span><span class="p">;</span><span class="w"></span>
<span class="linenos">153</span><span class="w">  </span><span class="n">flann</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">k_distances</span><span class="p">;</span><span class="w"></span>
<span class="linenos">154</span><span class="w">  </span><span class="n">flann</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w"></span>
<span class="linenos">155</span><span class="w">  </span><span class="c1">// Check if the data has already been saved to disk</span>
<span class="linenos">156</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pcl_fs</span><span class="o">::</span><span class="n">exists</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;training_data.h5&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">pcl_fs</span><span class="o">::</span><span class="n">exists</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;training_data.list&quot;</span><span class="p">))</span><span class="w"></span>
<span class="linenos">157</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos">158</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_error</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Could not find training data models files %s and %s!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="linenos">159</span><span class="w">        </span><span class="n">training_data_h5_file_name</span><span class="p">.</span><span class="n">c_str</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">training_data_list_file_name</span><span class="p">.</span><span class="n">c_str</span><span class="w"> </span><span class="p">());</span><span class="w"></span>
<span class="linenos">160</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">161</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">162</span><span class="w">  </span><span class="k">else</span><span class="w"></span>
<span class="linenos">163</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos">164</span><span class="w">    </span><span class="n">loadFileList</span><span class="w"> </span><span class="p">(</span><span class="n">models</span><span class="p">,</span><span class="w"> </span><span class="n">training_data_list_file_name</span><span class="p">);</span><span class="w"></span>
<span class="linenos">165</span><span class="w">    </span><span class="n">flann</span><span class="o">::</span><span class="n">load_from_file</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">training_data_h5_file_name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;training_data&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">166</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_highlight</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Training data found. Loaded %d VFH models from %s/%s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="linenos">167</span><span class="w">        </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">data</span><span class="p">.</span><span class="n">rows</span><span class="p">,</span><span class="w"> </span><span class="n">training_data_h5_file_name</span><span class="p">.</span><span class="n">c_str</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">training_data_list_file_name</span><span class="p">.</span><span class="n">c_str</span><span class="w"> </span><span class="p">());</span><span class="w"></span>
<span class="linenos">168</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">169</span>
<span class="linenos">170</span><span class="w">  </span><span class="c1">// Check if the tree index has already been saved to disk</span>
<span class="linenos">171</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pcl_fs</span><span class="o">::</span><span class="n">exists</span><span class="w"> </span><span class="p">(</span><span class="n">kdtree_idx_file_name</span><span class="p">))</span><span class="w"></span>
<span class="linenos">172</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos">173</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_error</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Could not find kd-tree index in file %s!&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">kdtree_idx_file_name</span><span class="p">.</span><span class="n">c_str</span><span class="w"> </span><span class="p">());</span><span class="w"></span>
<span class="linenos">174</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">175</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">176</span><span class="w">  </span><span class="k">else</span><span class="w"></span>
<span class="linenos">177</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos">178</span><span class="w">    </span><span class="n">flann</span><span class="o">::</span><span class="n">Index</span><span class="o">&lt;</span><span class="n">flann</span><span class="o">::</span><span class="n">ChiSquareDistance</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">flann</span><span class="o">::</span><span class="n">SavedIndexParams</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;kdtree.idx&quot;</span><span class="p">));</span><span class="w"></span>
<span class="linenos">179</span><span class="w">    </span><span class="n">index</span><span class="p">.</span><span class="n">buildIndex</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="linenos">180</span><span class="w">    </span><span class="n">nearestKSearch</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">histogram</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">k_indices</span><span class="p">,</span><span class="w"> </span><span class="n">k_distances</span><span class="p">);</span><span class="w"></span>
<span class="linenos">181</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">182</span>
<span class="linenos">183</span><span class="w">  </span><span class="c1">// Output the results on screen</span>
<span class="linenos">184</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_highlight</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;The closest %d neighbors for %s are:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="n">pcd_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]);</span><span class="w"></span>
<span class="linenos">185</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">k</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="linenos">186</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_info</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;    %d - %s (%d) with a distance of: %f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="linenos">187</span><span class="w">        </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">models</span><span class="p">.</span><span class="n">at</span><span class="w"> </span><span class="p">(</span><span class="n">k_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]).</span><span class="n">first</span><span class="p">.</span><span class="n">c_str</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">k_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">k_distances</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="linenos">188</span>
<span class="linenos">189</span><span class="w">  </span><span class="c1">// Load the results</span>
<span class="linenos">190</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">visualization</span><span class="o">::</span><span class="n">PCLVisualizer</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;VFH Cluster Classifier&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">191</span><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">y_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">std</span><span class="o">::</span><span class="n">floor</span><span class="w"> </span><span class="p">(</span><span class="n">sqrt</span><span class="w"> </span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">k</span><span class="p">));</span><span class="w"></span>
<span class="linenos">192</span><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">x_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y_s</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">std</span><span class="o">::</span><span class="n">ceil</span><span class="w"> </span><span class="p">((</span><span class="n">k</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">y_s</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y_s</span><span class="p">);</span><span class="w"></span>
<span class="linenos">193</span><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">x_step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">)(</span><span class="mi">1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">x_s</span><span class="p">);</span><span class="w"></span>
<span class="linenos">194</span><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">y_step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">)(</span><span class="mi">1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">y_s</span><span class="p">);</span><span class="w"></span>
<span class="linenos">195</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_highlight</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Preparing to load &quot;</span><span class="p">);</span><span class="w"> </span>
<span class="linenos">196</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_value</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">);</span><span class="w"> </span>
<span class="linenos">197</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_info</span><span class="w"> </span><span class="p">(</span><span class="s">&quot; files (&quot;</span><span class="p">);</span><span class="w"> </span>
<span class="linenos">198</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_value</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">x_s</span><span class="p">);</span><span class="w">    </span>
<span class="linenos">199</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_info</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">);</span><span class="w"> </span>
<span class="linenos">200</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_value</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">y_s</span><span class="p">);</span><span class="w"> </span>
<span class="linenos">201</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_info</span><span class="w"> </span><span class="p">(</span><span class="s">&quot; / &quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">202</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_value</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;%f&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">x_step</span><span class="p">);</span><span class="w"> </span>
<span class="linenos">203</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_info</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">);</span><span class="w"> </span>
<span class="linenos">204</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_value</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;%f&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">y_step</span><span class="p">);</span><span class="w"> </span>
<span class="linenos">205</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_info</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">206</span>
<span class="linenos">207</span><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">viewport</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">208</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">k</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="linenos">209</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos">210</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">cloud_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">models</span><span class="p">.</span><span class="n">at</span><span class="w"> </span><span class="p">(</span><span class="n">k_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]).</span><span class="n">first</span><span class="p">;</span><span class="w"></span>
<span class="linenos">211</span><span class="w">    </span><span class="n">boost</span><span class="o">::</span><span class="n">replace_last</span><span class="w"> </span><span class="p">(</span><span class="n">cloud_name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;_vfh&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">212</span>
<span class="linenos">213</span><span class="w">    </span><span class="n">p</span><span class="p">.</span><span class="n">createViewPort</span><span class="w"> </span><span class="p">(</span><span class="n">l</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x_step</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y_step</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">l</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x_step</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y_step</span><span class="p">,</span><span class="w"> </span><span class="n">viewport</span><span class="p">);</span><span class="w"></span>
<span class="linenos">214</span><span class="w">    </span><span class="n">l</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="linenos">215</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">l</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">x_s</span><span class="p">)</span><span class="w"></span>
<span class="linenos">216</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">217</span><span class="w">      </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">218</span><span class="w">      </span><span class="n">m</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="linenos">219</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">220</span>
<span class="linenos">221</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">PCLPointCloud2</span><span class="w"> </span><span class="n">cloud</span><span class="p">;</span><span class="w"></span>
<span class="linenos">222</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_highlight</span><span class="w"> </span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Loading &quot;</span><span class="p">);</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_value</span><span class="w"> </span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cloud_name</span><span class="p">.</span><span class="n">c_str</span><span class="w"> </span><span class="p">());</span><span class="w"></span>
<span class="linenos">223</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pcl</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">loadPCDFile</span><span class="w"> </span><span class="p">(</span><span class="n">cloud_name</span><span class="p">,</span><span class="w"> </span><span class="n">cloud</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">224</span><span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">225</span>
<span class="linenos">226</span><span class="w">    </span><span class="c1">// Convert from blob to PointCloud</span>
<span class="linenos">227</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cloud_xyz</span><span class="p">;</span><span class="w"></span>
<span class="linenos">228</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">fromPCLPointCloud2</span><span class="w"> </span><span class="p">(</span><span class="n">cloud</span><span class="p">,</span><span class="w"> </span><span class="n">cloud_xyz</span><span class="p">);</span><span class="w"></span>
<span class="linenos">229</span>
<span class="linenos">230</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cloud_xyz</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">231</span><span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="linenos">232</span>
<span class="linenos">233</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_info</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;[done, &quot;</span><span class="p">);</span><span class="w"> </span>
<span class="linenos">234</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_value</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;%zu&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cloud_xyz</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="p">()));</span><span class="w"></span>
<span class="linenos">235</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_info</span><span class="w"> </span><span class="p">(</span><span class="s">&quot; points]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">236</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_info</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Available dimensions: &quot;</span><span class="p">);</span><span class="w"> </span>
<span class="linenos">237</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_value</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">getFieldsList</span><span class="w"> </span><span class="p">(</span><span class="n">cloud</span><span class="p">).</span><span class="n">c_str</span><span class="w"> </span><span class="p">());</span><span class="w"></span>
<span class="linenos">238</span>
<span class="linenos">239</span><span class="w">    </span><span class="c1">// Demean the cloud</span>
<span class="linenos">240</span><span class="w">    </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector4f</span><span class="w"> </span><span class="n">centroid</span><span class="p">;</span><span class="w"></span>
<span class="linenos">241</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">compute3DCentroid</span><span class="w"> </span><span class="p">(</span><span class="n">cloud_xyz</span><span class="p">,</span><span class="w"> </span><span class="n">centroid</span><span class="p">);</span><span class="w"></span>
<span class="linenos">242</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span><span class="o">&gt;::</span><span class="n">Ptr</span><span class="w"> </span><span class="n">cloud_xyz_demean</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span><span class="o">&gt;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">243</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">demeanPointCloud</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">cloud_xyz</span><span class="p">,</span><span class="w"> </span><span class="n">centroid</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">cloud_xyz_demean</span><span class="p">);</span><span class="w"></span>
<span class="linenos">244</span><span class="w">    </span><span class="c1">// Add to renderer*</span>
<span class="linenos">245</span><span class="w">    </span><span class="n">p</span><span class="p">.</span><span class="n">addPointCloud</span><span class="w"> </span><span class="p">(</span><span class="n">cloud_xyz_demean</span><span class="p">,</span><span class="w"> </span><span class="n">cloud_name</span><span class="p">,</span><span class="w"> </span><span class="n">viewport</span><span class="p">);</span><span class="w"></span>
<span class="linenos">246</span><span class="w">    </span>
<span class="linenos">247</span><span class="w">    </span><span class="c1">// Check if the model found is within our inlier tolerance</span>
<span class="linenos">248</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">stringstream</span><span class="w"> </span><span class="n">ss</span><span class="p">;</span><span class="w"></span>
<span class="linenos">249</span><span class="w">    </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">k_distances</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="linenos">250</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">k_distances</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">thresh</span><span class="p">)</span><span class="w"></span>
<span class="linenos">251</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">252</span><span class="w">      </span><span class="n">p</span><span class="p">.</span><span class="n">addText</span><span class="w"> </span><span class="p">(</span><span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">viewport</span><span class="p">);</span><span class="w">  </span><span class="c1">// display the text with red</span>
<span class="linenos">253</span>
<span class="linenos">254</span><span class="w">      </span><span class="c1">// Create a red line</span>
<span class="linenos">255</span><span class="w">      </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span><span class="w"> </span><span class="n">min_p</span><span class="p">,</span><span class="w"> </span><span class="n">max_p</span><span class="p">;</span><span class="w"></span>
<span class="linenos">256</span><span class="w">      </span><span class="n">pcl</span><span class="o">::</span><span class="n">getMinMax3D</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">cloud_xyz_demean</span><span class="p">,</span><span class="w"> </span><span class="n">min_p</span><span class="p">,</span><span class="w"> </span><span class="n">max_p</span><span class="p">);</span><span class="w"></span>
<span class="linenos">257</span><span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">stringstream</span><span class="w"> </span><span class="n">line_name</span><span class="p">;</span><span class="w"></span>
<span class="linenos">258</span><span class="w">      </span><span class="n">line_name</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;line_&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="linenos">259</span><span class="w">      </span><span class="n">p</span><span class="p">.</span><span class="n">addLine</span><span class="w"> </span><span class="p">(</span><span class="n">min_p</span><span class="p">,</span><span class="w"> </span><span class="n">max_p</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">line_name</span><span class="p">.</span><span class="n">str</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">viewport</span><span class="p">);</span><span class="w"></span>
<span class="linenos">260</span><span class="w">      </span><span class="n">p</span><span class="p">.</span><span class="n">setShapeRenderingProperties</span><span class="w"> </span><span class="p">(</span><span class="n">pcl</span><span class="o">::</span><span class="n">visualization</span><span class="o">::</span><span class="n">PCL_VISUALIZER_LINE_WIDTH</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">line_name</span><span class="p">.</span><span class="n">str</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">viewport</span><span class="p">);</span><span class="w"></span>
<span class="linenos">261</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">262</span><span class="w">    </span><span class="k">else</span><span class="w"></span>
<span class="linenos">263</span><span class="w">      </span><span class="n">p</span><span class="p">.</span><span class="n">addText</span><span class="w"> </span><span class="p">(</span><span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">viewport</span><span class="p">);</span><span class="w"></span>
<span class="linenos">264</span>
<span class="linenos">265</span><span class="w">    </span><span class="c1">// Increase the font size for the score*</span>
<span class="linenos">266</span><span class="w">    </span><span class="n">p</span><span class="p">.</span><span class="n">setShapeRenderingProperties</span><span class="w"> </span><span class="p">(</span><span class="n">pcl</span><span class="o">::</span><span class="n">visualization</span><span class="o">::</span><span class="n">PCL_VISUALIZER_FONT_SIZE</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="p">,</span><span class="w"> </span><span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">viewport</span><span class="p">);</span><span class="w"></span>
<span class="linenos">267</span>
<span class="linenos">268</span><span class="w">    </span><span class="c1">// Add the cluster name</span>
<span class="linenos">269</span><span class="w">    </span><span class="n">p</span><span class="p">.</span><span class="n">addText</span><span class="w"> </span><span class="p">(</span><span class="n">cloud_name</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">cloud_name</span><span class="p">,</span><span class="w"> </span><span class="n">viewport</span><span class="p">);</span><span class="w"></span>
<span class="linenos">270</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">271</span><span class="w">  </span><span class="c1">// Add coordinate systems to all viewports</span>
<span class="linenos">272</span><span class="w">  </span><span class="n">p</span><span class="p">.</span><span class="n">addCoordinateSystem</span><span class="w"> </span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;global&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="linenos">273</span>
<span class="linenos">274</span><span class="w">  </span><span class="n">p</span><span class="p">.</span><span class="n">spin</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="linenos">275</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="linenos">276</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The above code snippet is slightly larger, because we also included some
visualization routines and some other “eye candy” stuff.</p>
<p>In lines:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pcd_indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">parse_file_extension_argument</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;.pcd&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">vfh_model</span><span class="w"> </span><span class="n">histogram</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">loadHist</span><span class="w"> </span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">pcd_indices</span><span class="p">.</span><span class="n">at</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">)],</span><span class="w"> </span><span class="n">histogram</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_error</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Cannot load test file %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="n">pcd_indices</span><span class="p">.</span><span class="n">at</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">)]);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">parse_argument</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-thresh&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">thresh</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Search for the k closest matches</span>
<span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">parse_argument</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-k&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_highlight</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Using &quot;</span><span class="p">);</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_value</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">);</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_info</span><span class="w"> </span><span class="p">(</span><span class="s">&quot; nearest neighbors.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>we load the first given user histogram (and ignore the rest). Then we proceed
at checking two command line parameters, namely <code class="docutils literal notranslate"><span class="pre">-k</span></code> which will define how
many nearest neighbors to check and display on screen, and <code class="docutils literal notranslate"><span class="pre">-thresh</span></code> which
defines a maximum distance metric after which we will start displaying red
lines (i.e., crossing) over the <strong>k</strong> models found on screen (eye candy!).</p>
<p>In lines:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">loadFileList</span><span class="w"> </span><span class="p">(</span><span class="n">models</span><span class="p">,</span><span class="w"> </span><span class="n">training_data_list_file_name</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">flann</span><span class="o">::</span><span class="n">load_from_file</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">training_data_h5_file_name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;training_data&quot;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>we load the training data from disk, together with the list of file names that
we previously stored in <code class="docutils literal notranslate"><span class="pre">build_tree.cpp</span></code>. Then, we read the kd-tree and rebuild the index:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">flann</span><span class="o">::</span><span class="n">Index</span><span class="o">&lt;</span><span class="n">flann</span><span class="o">::</span><span class="n">ChiSquareDistance</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">flann</span><span class="o">::</span><span class="n">SavedIndexParams</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;kdtree.idx&quot;</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">index</span><span class="p">.</span><span class="n">buildIndex</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
</pre></div>
</div>
<p>Here we need to make sure that we use the <strong>exact</strong> distance metric
(<code class="docutils literal notranslate"><span class="pre">ChiSquareDistance</span></code> in this case), as the one that we used while creating
the tree. The most important part of the code comes here:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">nearestKSearch</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">histogram</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">k_indices</span><span class="p">,</span><span class="w"> </span><span class="n">k_distances</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Inside <code class="docutils literal notranslate"><span class="pre">nearestKSearch</span></code>, we first convert the query point to FLANN format:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">flann</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flann</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">model</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="p">()],</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">memcpy</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">.</span><span class="n">ptr</span><span class="w"> </span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">model</span><span class="p">.</span><span class="n">second</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">cols</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">rows</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">));</span><span class="w"></span>
</pre></div>
</div>
<p>Followed by obtaining the resultant nearest neighbor indices and distances for the query in:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flann</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">distances</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flann</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">index</span><span class="p">.</span><span class="n">knnSearch</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">indices</span><span class="p">,</span><span class="w"> </span><span class="n">distances</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">flann</span><span class="o">::</span><span class="n">SearchParams</span><span class="w"> </span><span class="p">(</span><span class="mi">512</span><span class="p">));</span><span class="w"></span>
</pre></div>
</div>
<p>Lines:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">index</span><span class="p">.</span><span class="n">buildIndex</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">nearestKSearch</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">histogram</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">k_indices</span><span class="p">,</span><span class="w"> </span><span class="n">k_distances</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Output the results on screen</span>
<span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_highlight</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;The closest %d neighbors for %s are:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="n">pcd_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]);</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">k</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_info</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;    %d - %s (%d) with a distance of: %f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">models</span><span class="p">.</span><span class="n">at</span><span class="w"> </span><span class="p">(</span><span class="n">k_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]).</span><span class="n">first</span><span class="p">.</span><span class="n">c_str</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">k_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">k_distances</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Load the results</span>
<span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">visualization</span><span class="o">::</span><span class="n">PCLVisualizer</span><span class="w"> </span><span class="nf">p</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;VFH Cluster Classifier&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">y_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">std</span><span class="o">::</span><span class="n">floor</span><span class="w"> </span><span class="p">(</span><span class="n">sqrt</span><span class="w"> </span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">k</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">x_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y_s</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">std</span><span class="o">::</span><span class="n">ceil</span><span class="w"> </span><span class="p">((</span><span class="n">k</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">y_s</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y_s</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">x_step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">)(</span><span class="mi">1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">x_s</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>create a <code class="docutils literal notranslate"><span class="pre">PCLVisualizer</span></code> object, and sets up a set of different viewports (e.g., splits the screen into different chunks), which will be enabled in:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">p</span><span class="p">.</span><span class="n">createViewPort</span><span class="w"> </span><span class="p">(</span><span class="n">l</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x_step</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y_step</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">l</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x_step</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y_step</span><span class="p">,</span><span class="w"> </span><span class="n">viewport</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Using the file names representing the models that we previously obtained in
<code class="docutils literal notranslate"><span class="pre">loadFileList</span></code>, we proceed at loading the model file names using:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">PCLPointCloud2</span><span class="w"> </span><span class="n">cloud</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_highlight</span><span class="w"> </span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Loading &quot;</span><span class="p">);</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">console</span><span class="o">::</span><span class="n">print_value</span><span class="w"> </span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cloud_name</span><span class="p">.</span><span class="n">c_str</span><span class="w"> </span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pcl</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">loadPCDFile</span><span class="w"> </span><span class="p">(</span><span class="n">cloud_name</span><span class="p">,</span><span class="w"> </span><span class="n">cloud</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Convert from blob to PointCloud</span>
<span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cloud_xyz</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">fromPCLPointCloud2</span><span class="w"> </span><span class="p">(</span><span class="n">cloud</span><span class="p">,</span><span class="w"> </span><span class="n">cloud_xyz</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>For visualization purposes, we demean the point cloud by computing its centroid and then subtracting it:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector4f</span><span class="w"> </span><span class="n">centroid</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">compute3DCentroid</span><span class="w"> </span><span class="p">(</span><span class="n">cloud_xyz</span><span class="p">,</span><span class="w"> </span><span class="n">centroid</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span><span class="o">&gt;::</span><span class="n">Ptr</span><span class="w"> </span><span class="n">cloud_xyz_demean</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span><span class="o">&gt;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">demeanPointCloud</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">cloud_xyz</span><span class="p">,</span><span class="w"> </span><span class="n">centroid</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">cloud_xyz_demean</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Add to renderer*</span>
<span class="w">    </span><span class="n">p</span><span class="p">.</span><span class="n">addPointCloud</span><span class="w"> </span><span class="p">(</span><span class="n">cloud_xyz_demean</span><span class="p">,</span><span class="w"> </span><span class="n">cloud_name</span><span class="p">,</span><span class="w"> </span><span class="n">viewport</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Finally we check if the distance obtained by <code class="docutils literal notranslate"><span class="pre">nearestKSearch</span></code> is larger than the user given threshold, and if it is, we display a red line over the cloud that is being rendered in the viewport:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">      </span><span class="c1">// Create a red line</span>
<span class="w">      </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span><span class="w"> </span><span class="n">min_p</span><span class="p">,</span><span class="w"> </span><span class="n">max_p</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">pcl</span><span class="o">::</span><span class="n">getMinMax3D</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">cloud_xyz_demean</span><span class="p">,</span><span class="w"> </span><span class="n">min_p</span><span class="p">,</span><span class="w"> </span><span class="n">max_p</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">stringstream</span><span class="w"> </span><span class="n">line_name</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">line_name</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;line_&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">p</span><span class="p">.</span><span class="n">addLine</span><span class="w"> </span><span class="p">(</span><span class="n">min_p</span><span class="p">,</span><span class="w"> </span><span class="n">max_p</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">line_name</span><span class="p">.</span><span class="n">str</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">viewport</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">p</span><span class="p">.</span><span class="n">setShapeRenderingProperties</span><span class="w"> </span><span class="p">(</span><span class="n">pcl</span><span class="o">::</span><span class="n">visualization</span><span class="o">::</span><span class="n">PCL_VISUALIZER_LINE_WIDTH</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">line_name</span><span class="p">.</span><span class="n">str</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">viewport</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="compiling-and-running-the-code">
<h1>Compiling and running the code</h1>
<p>Create a new <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> file, and put the following content into it</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span><span class="w"> </span><span class="s">3.5</span><span class="w"> </span><span class="s">FATAL_ERROR</span><span class="p">)</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="nb">project</span><span class="p">(</span><span class="s">vfh_cluster_classifier</span><span class="p">)</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="nb">find_package</span><span class="p">(</span><span class="s">PCL</span><span class="w"> </span><span class="s">1.2</span><span class="w"> </span><span class="s">REQUIRED</span><span class="p">)</span>
<span class="linenos"> 6</span><span class="nb">include_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">PCL_INCLUDE_DIRS</span><span class="o">}</span><span class="p">)</span>
<span class="linenos"> 7</span><span class="nb">link_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">PCL_LIBRARY_DIRS</span><span class="o">}</span><span class="p">)</span>
<span class="linenos"> 8</span><span class="nb">add_definitions</span><span class="p">(</span><span class="o">${</span><span class="nv">PCL_DEFINITIONS</span><span class="o">}</span><span class="p">)</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="nb">find_package</span><span class="p">(</span><span class="s">HDF5</span><span class="w"> </span><span class="s">REQUIRED</span><span class="p">)</span>
<span class="linenos">11</span><span class="nb">find_package</span><span class="p">(</span><span class="s">FLANN</span><span class="w"> </span><span class="s">REQUIRED</span><span class="p">)</span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="nb">include_directories</span><span class="p">(</span><span class="s">SYSTEM</span>
<span class="linenos">14</span><span class="w">  </span><span class="o">${</span><span class="nv">HDF5_INCLUDE_DIR</span><span class="o">}</span>
<span class="linenos">15</span><span class="p">)</span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="nb">add_executable</span><span class="p">(</span><span class="s">build_tree</span><span class="w"> </span><span class="s">build_tree.cpp</span><span class="p">)</span>
<span class="linenos">18</span><span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">build_tree</span><span class="w"> </span><span class="o">${</span><span class="nv">PCL_LIBRARIES</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">Boost_LIBRARIES</span><span class="o">}</span>
<span class="linenos">19</span><span class="w">                                 </span><span class="s">FLANN::FLANN</span><span class="w"> </span><span class="o">${</span><span class="nv">HDF5_LIBRARIES</span><span class="o">}</span><span class="p">)</span>
<span class="linenos">20</span>
<span class="linenos">21</span><span class="nb">add_executable</span><span class="p">(</span><span class="s">nearest_neighbors</span><span class="w"> </span><span class="s">nearest_neighbors.cpp</span><span class="p">)</span>
<span class="linenos">22</span><span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">nearest_neighbors</span><span class="w"> </span><span class="o">${</span><span class="nv">PCL_LIBRARIES</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">Boost_LIBRARIES</span><span class="o">}</span><span class="w"> </span><span class="s">FLANN::FLANN</span><span class="w"> </span><span class="o">${</span><span class="nv">HDF5_LIBRARIES</span><span class="o">}</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you are running this tutorial on Windows, you have to install (<a class="reference external" href="http://www.hdfgroup.org/ftp/HDF5/current/bin/windows/">HDF5 1.8.7 Shared Library</a>). If CMake is not able to find HDF5,
you can manually supply the include directory in HDF5_INCLUDE_DIR variable and the full path of <strong>hdf5dll.lib</strong> in HDF5_hdf5_LIBRARY variable.
Make sure that the needed dlls are in the same folder as the executables.</p>
</div>
<p>The above assumes that your two source files (<code class="docutils literal notranslate"><span class="pre">build_tree.cpp</span></code> and <code class="docutils literal notranslate"><span class="pre">nearest_neighbors.cpp</span></code>) are stored into the <em>src/</em> subdirectory.</p>
<p>Then, make sure that the datasets you downloaded (<a class="reference external" href="https://raw.github.com/PointCloudLibrary/data/master/tutorials/vfh_recognition/vfh_recognition_tutorial_data.tbz">vfh_recognition_tutorial_data.tbz</a>) are unpacked in this directory, thus creating a <em>data/</em> subdirectory.</p>
<p>After you have made the executable, you can run them like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ./build/build_tree data/
</pre></div>
</div>
<p>You should see the following output on screen:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">Loading</span> <span class="n">data</span><span class="o">/</span><span class="mf">001.324.25</span> <span class="p">(</span><span class="mi">0</span> <span class="n">models</span> <span class="n">loaded</span> <span class="n">so</span> <span class="n">far</span><span class="p">)</span><span class="o">.</span>
<span class="o">&gt;</span> <span class="n">Loading</span> <span class="n">data</span><span class="o">/</span><span class="mf">800.919.49</span> <span class="p">(</span><span class="mi">13</span> <span class="n">models</span> <span class="n">loaded</span> <span class="n">so</span> <span class="n">far</span><span class="p">)</span><span class="o">.</span>
<span class="o">&gt;</span> <span class="n">Loading</span> <span class="n">data</span><span class="o">/</span><span class="mf">100.922.16</span> <span class="p">(</span><span class="mi">27</span> <span class="n">models</span> <span class="n">loaded</span> <span class="n">so</span> <span class="n">far</span><span class="p">)</span><span class="o">.</span>
<span class="o">&gt;</span> <span class="n">Loading</span> <span class="n">data</span><span class="o">/</span><span class="mf">901.125.07</span> <span class="p">(</span><span class="mi">47</span> <span class="n">models</span> <span class="n">loaded</span> <span class="n">so</span> <span class="n">far</span><span class="p">)</span><span class="o">.</span>
<span class="o">&gt;</span> <span class="n">Loading</span> <span class="n">data</span><span class="o">/</span><span class="mf">000.580.67</span> <span class="p">(</span><span class="mi">65</span> <span class="n">models</span> <span class="n">loaded</span> <span class="n">so</span> <span class="n">far</span><span class="p">)</span><span class="o">.</span>
<span class="o">&gt;</span> <span class="n">Loading</span> <span class="n">data</span><span class="o">/</span><span class="mf">463.156.00</span> <span class="p">(</span><span class="mi">81</span> <span class="n">models</span> <span class="n">loaded</span> <span class="n">so</span> <span class="n">far</span><span class="p">)</span><span class="o">.</span>
<span class="o">&gt;</span> <span class="n">Loading</span> <span class="n">data</span><span class="o">/</span><span class="mf">401.431.44</span> <span class="p">(</span><span class="mi">97</span> <span class="n">models</span> <span class="n">loaded</span> <span class="n">so</span> <span class="n">far</span><span class="p">)</span><span class="o">.</span>
<span class="o">&gt;</span> <span class="n">Loading</span> <span class="n">data</span><span class="o">/</span><span class="mf">100.919.00</span> <span class="p">(</span><span class="mi">113</span> <span class="n">models</span> <span class="n">loaded</span> <span class="n">so</span> <span class="n">far</span><span class="p">)</span><span class="o">.</span>
<span class="o">&gt;</span> <span class="n">Loading</span> <span class="n">data</span><span class="o">/</span><span class="mf">401.324.52</span> <span class="p">(</span><span class="mi">134</span> <span class="n">models</span> <span class="n">loaded</span> <span class="n">so</span> <span class="n">far</span><span class="p">)</span><span class="o">.</span>
<span class="o">&gt;</span> <span class="n">Loading</span> <span class="n">data</span><span class="o">/</span><span class="mf">201.327.78</span> <span class="p">(</span><span class="mi">150</span> <span class="n">models</span> <span class="n">loaded</span> <span class="n">so</span> <span class="n">far</span><span class="p">)</span><span class="o">.</span>
<span class="o">&gt;</span> <span class="n">Loading</span> <span class="n">data</span><span class="o">/</span><span class="mf">300.151.23</span> <span class="p">(</span><span class="mi">166</span> <span class="n">models</span> <span class="n">loaded</span> <span class="n">so</span> <span class="n">far</span><span class="p">)</span><span class="o">.</span>
<span class="o">&gt;</span> <span class="n">Loading</span> <span class="n">data</span><span class="o">/</span><span class="mf">200.921.07</span> <span class="p">(</span><span class="mi">180</span> <span class="n">models</span> <span class="n">loaded</span> <span class="n">so</span> <span class="n">far</span><span class="p">)</span><span class="o">.</span>
<span class="o">&gt;</span> <span class="n">Loaded</span> <span class="mi">195</span> <span class="n">VFH</span> <span class="n">models</span><span class="o">.</span> <span class="n">Creating</span> <span class="n">training</span> <span class="n">data</span> <span class="n">training_data</span><span class="o">.</span><span class="n">h5</span><span class="o">/</span><span class="n">training_data</span><span class="o">.</span><span class="n">list</span><span class="o">.</span>
<span class="n">Building</span> <span class="n">the</span> <span class="n">kdtree</span> <span class="n">index</span> <span class="p">(</span><span class="n">kdtree</span><span class="o">.</span><span class="n">idx</span><span class="p">)</span> <span class="k">for</span> <span class="mi">195</span> <span class="n">elements</span><span class="o">...</span>
</pre></div>
</div>
<p>The above crawled the <em>data/</em> subdirectory, and created a kd-tree with 195 entries. To run the nearest neighbor testing example, you have two options:</p>
<blockquote>
<div><ol class="arabic">
<li><p>Either run the following command manually, and select one of the datasets that we provided as a testing sample, like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">build</span><span class="o">/</span><span class="n">nearest_neighbors</span> <span class="o">-</span><span class="n">k</span> <span class="mi">16</span> <span class="o">-</span><span class="n">thresh</span> <span class="mi">50</span> <span class="n">data</span><span class="o">/</span><span class="mf">000.580.67</span><span class="o">/</span><span class="mi">1258730231333</span><span class="n">_cluster_0_nxyz_vfh</span><span class="o">.</span><span class="n">pcd</span>
</pre></div>
</div>
</li>
<li><p>Or, if you are on a linux system, you can place the following on a bash script file (e.g., <code class="docutils literal notranslate"><span class="pre">test.sh</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash

# Example directory containing _vfh.pcd files
DATA=data

# Inlier distance threshold
thresh=50

# Get the closest K nearest neighbors
k=16

for i in `find $DATA -type d -name &quot;*&quot;`
do
  echo $i
  for j in `find $i -type f \( -iname &quot;*cluster*_vfh.pcd&quot; \) | sort -R`
  do
    echo $j
    ./build/nearest_neighbors -k $k -thresh $thresh $j -cam &quot;0.403137,0.868471/0,0,0/-0.0932051,-0.201608,-0.518939/-0.00471487,-0.931831,0.362863/1464,764/6,72&quot;
  done
done
</pre></div>
</div>
</li>
</ol>
<blockquote>
<div><p>and run the script like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bash</span> <span class="n">test</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
</div></blockquote>
</div></blockquote>
<p>You should see <em>recognition</em> examples like the ones shown below:</p>
<img alt="_images/vfh_example1.jpg" src="_images/vfh_example1.jpg" />
<img alt="_images/vfh_example2.jpg" src="_images/vfh_example2.jpg" />
<img alt="_images/vfh_example3.jpg" src="_images/vfh_example3.jpg" />
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>