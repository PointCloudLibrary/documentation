<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fitting trimmed B-splines to unordered point clouds &mdash; Point Cloud Library 1.14.1-dev documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> Point Cloud Library
          </a>
              <div class="version">
                1.14.1-dev
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">Fitting trimmed B-splines to unordered point clouds</a></li>
<li><a class="reference internal" href="#theoretical-background">Theoretical background</a></li>
<li><a class="reference internal" href="#pcl-installation-settings">PCL installation settings</a></li>
<li><a class="reference internal" href="#the-code">The code</a></li>
<li><a class="reference internal" href="#the-explanation">The explanation</a><ul>
<li><a class="reference internal" href="#initialization-of-the-b-spline-surface">Initialization of the B-spline surface</a></li>
<li><a class="reference internal" href="#refinement-and-fitting-of-the-b-spline-surface">Refinement and fitting of the B-spline surface</a></li>
<li><a class="reference internal" href="#initialization-of-the-b-spline-curve">Initialization of the B-spline curve</a></li>
<li><a class="reference internal" href="#fitting-of-the-b-spline-curve">Fitting of the B-spline curve</a></li>
<li><a class="reference internal" href="#triangulation-of-the-trimmed-b-spline-surface">Triangulation of the trimmed B-spline surface</a></li>
</ul>
</li>
<li><a class="reference internal" href="#some-hints">Some hints</a></li>
<li><a class="reference internal" href="#compiling-and-running-the-program">Compiling and running the program</a></li>
<li><a class="reference internal" href="#saving-and-viewing-the-result">Saving and viewing the result</a></li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Point Cloud Library</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Fitting trimmed B-splines to unordered point clouds</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="fitting-trimmed-b-splines-to-unordered-point-clouds">
<span id="bspline-fitting"></span><h1>Fitting trimmed B-splines to unordered point clouds</h1>
<p>This tutorial explains how to run a B-spline fitting algorithm on a
point-cloud, to obtain a smooth, parametric surface representation.
The algorithm consists of the following steps:</p>
<ul class="simple">
<li><p>Initialization of the B-spline surface by using the Principal Component Analysis (PCA). This
assumes that the point-cloud has two main orientations, i.e. that it is roughly planar.</p></li>
<li><p>Refinement and fitting of the B-spline surface.</p></li>
<li><p>Circular initialization of the B-spline curve. Here we assume that the point-cloud is
compact, i.e. no separated clusters.</p></li>
<li><p>Fitting of the B-spline curve.</p></li>
<li><p>Triangulation of the trimmed B-spline surface.</p></li>
</ul>
<p>In this video, the algorithm is applied to the frontal scan of the stanford bunny (204800 points):</p>
<iframe title="Trimmed B-spline surface fitting" width="480" height="390" src="https://www.youtube.com/embed/trH2kWELvyw?rel=0" frameborder="0" allowfullscreen></iframe></section>
<section id="theoretical-background">
<h1>Theoretical background</h1>
<p>Theoretical information on the algorithm can be found in this <a class="reference external" href="http://pointclouds.org/blog/trcs/moerwald/index.php">report</a> and in my <a class="reference external" href="http://users.acin.tuwien.ac.at/tmoerwald/?site=3">PhD thesis</a>.</p>
</section>
<section id="pcl-installation-settings">
<h1>PCL installation settings</h1>
<p>Please note that the modules for NURBS and B-splines are not enabled by default.
Make sure you enable “BUILD_surface_on_nurbs” in your ccmake configuration, by setting it to ON.</p>
<p>If your license permits, also enable “USE_UMFPACK” for sparse linear solving.
This requires SuiteSparse (libsuitesparse-dev in Ubuntu) which is faster,
allows more degrees of freedom (i.e. control points) and more data points.</p>
<p>The program created during this tutorial is available in
<em>pcl/examples/surface/example_nurbs_fitting_surface.cpp</em> and is built when
“BUILD_examples” is set to ON. This will create the binary called <em>pcl_example_nurbs_fitting_surface</em>
in your <em>bin</em> folder.</p>
</section>
<section id="the-code">
<h1>The code</h1>
<p>The cpp file used in this tutorial can be found in <em>pcl/doc/tutorials/content/sources/bspline_fitting/bspline_fitting.cpp</em>.
You can find the input file at <em>pcl/test/bunny.pcd</em>.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/point_cloud.h&gt;</span><span class="cp"></span>
<span class="linenos">  2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/point_types.h&gt;</span><span class="cp"></span>
<span class="linenos">  3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/io/pcd_io.h&gt;</span><span class="cp"></span>
<span class="linenos">  4</span>
<span class="linenos">  5</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/visualization/pcl_visualizer.h&gt;</span><span class="cp"></span>
<span class="linenos">  6</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/surface/on_nurbs/fitting_surface_tdm.h&gt;</span><span class="cp"></span>
<span class="linenos">  7</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/surface/on_nurbs/fitting_curve_2d_asdm.h&gt;</span><span class="cp"></span>
<span class="linenos">  8</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/surface/on_nurbs/triangulation.h&gt;</span><span class="cp"></span>
<span class="linenos">  9</span>
<span class="linenos"> 10</span><span class="k">typedef</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span><span class="w"> </span><span class="n">Point</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 11</span>
<span class="linenos"> 12</span><span class="kt">void</span><span class="w"></span>
<span class="linenos"> 13</span><span class="nf">PointCloud2Vector3d</span><span class="w"> </span><span class="p">(</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="o">&lt;</span><span class="n">Point</span><span class="o">&gt;::</span><span class="n">Ptr</span><span class="w"> </span><span class="n">cloud</span><span class="p">,</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">on_nurbs</span><span class="o">::</span><span class="n">vector_vec3d</span><span class="w"> </span><span class="o">&amp;</span><span class="n">data</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 14</span>
<span class="linenos"> 15</span><span class="kt">void</span><span class="w"></span>
<span class="linenos"> 16</span><span class="nf">visualizeCurve</span><span class="w"> </span><span class="p">(</span><span class="n">ON_NurbsCurve</span><span class="w"> </span><span class="o">&amp;</span><span class="n">curve</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 17</span><span class="w">                </span><span class="n">ON_NurbsSurface</span><span class="w"> </span><span class="o">&amp;</span><span class="n">surface</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 18</span><span class="w">                </span><span class="n">pcl</span><span class="o">::</span><span class="n">visualization</span><span class="o">::</span><span class="n">PCLVisualizer</span><span class="w"> </span><span class="o">&amp;</span><span class="n">viewer</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 19</span>
<span class="linenos"> 20</span><span class="kt">int</span><span class="w"></span>
<span class="linenos"> 21</span><span class="nf">main</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"></span>
<span class="linenos"> 22</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 23</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">pcd_file</span><span class="p">,</span><span class="w"> </span><span class="n">file_3dm</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 24</span>
<span class="linenos"> 25</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 26</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 27</span><span class="w">    </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Usage: pcl_example_nurbs_fitting_surface pcd&lt;PointXYZ&gt;-in-file 3dm-out-file</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 28</span><span class="w">    </span><span class="n">exit</span><span class="w"> </span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 29</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 30</span><span class="w">  </span><span class="n">pcd_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="linenos"> 31</span><span class="w">  </span><span class="n">file_3dm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w"></span>
<span class="linenos"> 32</span>
<span class="linenos"> 33</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">visualization</span><span class="o">::</span><span class="n">PCLVisualizer</span><span class="w"> </span><span class="n">viewer</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;B-spline surface fitting&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 34</span><span class="w">  </span><span class="n">viewer</span><span class="p">.</span><span class="n">setSize</span><span class="w"> </span><span class="p">(</span><span class="mi">800</span><span class="p">,</span><span class="w"> </span><span class="mi">600</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 35</span>
<span class="linenos"> 36</span><span class="w">  </span><span class="c1">// ############################################################################</span>
<span class="linenos"> 37</span><span class="w">  </span><span class="c1">// load point cloud</span>
<span class="linenos"> 38</span>
<span class="linenos"> 39</span><span class="w">  </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;  loading %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pcd_file</span><span class="p">.</span><span class="n">c_str</span><span class="w"> </span><span class="p">());</span><span class="w"></span>
<span class="linenos"> 40</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="o">&lt;</span><span class="n">Point</span><span class="o">&gt;::</span><span class="n">Ptr</span><span class="w"> </span><span class="n">cloud</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="o">&lt;</span><span class="n">Point</span><span class="o">&gt;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 41</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">PCLPointCloud2</span><span class="w"> </span><span class="n">cloud2</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 42</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">on_nurbs</span><span class="o">::</span><span class="n">NurbsDataSurface</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 43</span>
<span class="linenos"> 44</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pcl</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">loadPCDFile</span><span class="w"> </span><span class="p">(</span><span class="n">pcd_file</span><span class="p">,</span><span class="w"> </span><span class="n">cloud2</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 45</span><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;  PCD file not found.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 46</span>
<span class="linenos"> 47</span><span class="w">  </span><span class="n">fromPCLPointCloud2</span><span class="w"> </span><span class="p">(</span><span class="n">cloud2</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">cloud</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 48</span><span class="w">  </span><span class="n">PointCloud2Vector3d</span><span class="w"> </span><span class="p">(</span><span class="n">cloud</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">interior</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 49</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">visualization</span><span class="o">::</span><span class="n">PointCloudColorHandlerCustom</span><span class="o">&lt;</span><span class="n">Point</span><span class="o">&gt;</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="p">(</span><span class="n">cloud</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 50</span><span class="w">  </span><span class="n">viewer</span><span class="p">.</span><span class="n">addPointCloud</span><span class="o">&lt;</span><span class="n">Point</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">cloud</span><span class="p">,</span><span class="w"> </span><span class="n">handler</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cloud_cylinder&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 51</span><span class="w">  </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;  %lu points in data set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cloud</span><span class="o">-&gt;</span><span class="n">size</span><span class="w"> </span><span class="p">());</span><span class="w"></span>
<span class="linenos"> 52</span>
<span class="linenos"> 53</span><span class="w">  </span><span class="c1">// ############################################################################</span>
<span class="linenos"> 54</span><span class="w">  </span><span class="c1">// fit B-spline surface</span>
<span class="linenos"> 55</span>
<span class="linenos"> 56</span><span class="w">  </span><span class="c1">// parameters</span>
<span class="linenos"> 57</span><span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 58</span><span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">refinement</span><span class="w"> </span><span class="p">(</span><span class="mi">5</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 59</span><span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">iterations</span><span class="w"> </span><span class="p">(</span><span class="mi">10</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 60</span><span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">mesh_resolution</span><span class="w"> </span><span class="p">(</span><span class="mi">256</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 61</span>
<span class="linenos"> 62</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">on_nurbs</span><span class="o">::</span><span class="n">FittingSurface</span><span class="o">::</span><span class="n">Parameter</span><span class="w"> </span><span class="n">params</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 63</span><span class="w">  </span><span class="n">params</span><span class="p">.</span><span class="n">interior_smoothness</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.2</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 64</span><span class="w">  </span><span class="n">params</span><span class="p">.</span><span class="n">interior_weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 65</span><span class="w">  </span><span class="n">params</span><span class="p">.</span><span class="n">boundary_smoothness</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.2</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 66</span><span class="w">  </span><span class="n">params</span><span class="p">.</span><span class="n">boundary_weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 67</span>
<span class="linenos"> 68</span><span class="w">  </span><span class="c1">// initialize</span>
<span class="linenos"> 69</span><span class="w">  </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;  surface fitting ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 70</span><span class="w">  </span><span class="n">ON_NurbsSurface</span><span class="w"> </span><span class="n">nurbs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">on_nurbs</span><span class="o">::</span><span class="n">FittingSurface</span><span class="o">::</span><span class="n">initNurbsPCABoundingBox</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">data</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 71</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">on_nurbs</span><span class="o">::</span><span class="n">FittingSurface</span><span class="w"> </span><span class="n">fit</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">nurbs</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 72</span><span class="w">  </span><span class="c1">//  fit.setQuiet (false); // enable/disable debug output</span>
<span class="linenos"> 73</span>
<span class="linenos"> 74</span><span class="w">  </span><span class="c1">// mesh for visualization</span>
<span class="linenos"> 75</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">PolygonMesh</span><span class="w"> </span><span class="n">mesh</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 76</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span><span class="o">&gt;::</span><span class="n">Ptr</span><span class="w"> </span><span class="n">mesh_cloud</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span><span class="o">&gt;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 77</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">Vertices</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mesh_vertices</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 78</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">mesh_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;mesh_nurbs&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 79</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">on_nurbs</span><span class="o">::</span><span class="n">Triangulation</span><span class="o">::</span><span class="n">convertSurface2PolygonMesh</span><span class="w"> </span><span class="p">(</span><span class="n">fit</span><span class="p">.</span><span class="n">m_nurbs</span><span class="p">,</span><span class="w"> </span><span class="n">mesh</span><span class="p">,</span><span class="w"> </span><span class="n">mesh_resolution</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 80</span><span class="w">  </span><span class="n">viewer</span><span class="p">.</span><span class="n">addPolygonMesh</span><span class="w"> </span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span><span class="w"> </span><span class="n">mesh_id</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 81</span>
<span class="linenos"> 82</span><span class="w">  </span><span class="c1">// surface refinement</span>
<span class="linenos"> 83</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">refinement</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 84</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 85</span><span class="w">    </span><span class="n">fit</span><span class="p">.</span><span class="n">refine</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 86</span><span class="w">    </span><span class="n">fit</span><span class="p">.</span><span class="n">refine</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 87</span><span class="w">    </span><span class="n">fit</span><span class="p">.</span><span class="n">assemble</span><span class="w"> </span><span class="p">(</span><span class="n">params</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 88</span><span class="w">    </span><span class="n">fit</span><span class="p">.</span><span class="n">solve</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="linenos"> 89</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">on_nurbs</span><span class="o">::</span><span class="n">Triangulation</span><span class="o">::</span><span class="n">convertSurface2Vertices</span><span class="w"> </span><span class="p">(</span><span class="n">fit</span><span class="p">.</span><span class="n">m_nurbs</span><span class="p">,</span><span class="w"> </span><span class="n">mesh_cloud</span><span class="p">,</span><span class="w"> </span><span class="n">mesh_vertices</span><span class="p">,</span><span class="w"> </span><span class="n">mesh_resolution</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 90</span><span class="w">    </span><span class="n">viewer</span><span class="p">.</span><span class="n">updatePolygonMesh</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">mesh_cloud</span><span class="p">,</span><span class="w"> </span><span class="n">mesh_vertices</span><span class="p">,</span><span class="w"> </span><span class="n">mesh_id</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 91</span><span class="w">    </span><span class="n">viewer</span><span class="p">.</span><span class="n">spinOnce</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="linenos"> 92</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 93</span>
<span class="linenos"> 94</span><span class="w">  </span><span class="c1">// surface fitting with final refinement level</span>
<span class="linenos"> 95</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">iterations</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 96</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 97</span><span class="w">    </span><span class="n">fit</span><span class="p">.</span><span class="n">assemble</span><span class="w"> </span><span class="p">(</span><span class="n">params</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 98</span><span class="w">    </span><span class="n">fit</span><span class="p">.</span><span class="n">solve</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="linenos"> 99</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">on_nurbs</span><span class="o">::</span><span class="n">Triangulation</span><span class="o">::</span><span class="n">convertSurface2Vertices</span><span class="w"> </span><span class="p">(</span><span class="n">fit</span><span class="p">.</span><span class="n">m_nurbs</span><span class="p">,</span><span class="w"> </span><span class="n">mesh_cloud</span><span class="p">,</span><span class="w"> </span><span class="n">mesh_vertices</span><span class="p">,</span><span class="w"> </span><span class="n">mesh_resolution</span><span class="p">);</span><span class="w"></span>
<span class="linenos">100</span><span class="w">    </span><span class="n">viewer</span><span class="p">.</span><span class="n">updatePolygonMesh</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">mesh_cloud</span><span class="p">,</span><span class="w"> </span><span class="n">mesh_vertices</span><span class="p">,</span><span class="w"> </span><span class="n">mesh_id</span><span class="p">);</span><span class="w"></span>
<span class="linenos">101</span><span class="w">    </span><span class="n">viewer</span><span class="p">.</span><span class="n">spinOnce</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="linenos">102</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">103</span>
<span class="linenos">104</span><span class="w">  </span><span class="c1">// ############################################################################</span>
<span class="linenos">105</span><span class="w">  </span><span class="c1">// fit B-spline curve</span>
<span class="linenos">106</span>
<span class="linenos">107</span><span class="w">  </span><span class="c1">// parameters</span>
<span class="linenos">108</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">on_nurbs</span><span class="o">::</span><span class="n">FittingCurve2dAPDM</span><span class="o">::</span><span class="n">FitParameter</span><span class="w"> </span><span class="n">curve_params</span><span class="p">;</span><span class="w"></span>
<span class="linenos">109</span><span class="w">  </span><span class="n">curve_params</span><span class="p">.</span><span class="n">addCPsAccuracy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5e-2</span><span class="p">;</span><span class="w"></span>
<span class="linenos">110</span><span class="w">  </span><span class="n">curve_params</span><span class="p">.</span><span class="n">addCPsIteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="linenos">111</span><span class="w">  </span><span class="n">curve_params</span><span class="p">.</span><span class="n">maxCPs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">200</span><span class="p">;</span><span class="w"></span>
<span class="linenos">112</span><span class="w">  </span><span class="n">curve_params</span><span class="p">.</span><span class="n">accuracy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e-3</span><span class="p">;</span><span class="w"></span>
<span class="linenos">113</span><span class="w">  </span><span class="n">curve_params</span><span class="p">.</span><span class="n">iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"></span>
<span class="linenos">114</span>
<span class="linenos">115</span><span class="w">  </span><span class="n">curve_params</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">closest_point_resolution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">116</span><span class="w">  </span><span class="n">curve_params</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">closest_point_weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">117</span><span class="w">  </span><span class="n">curve_params</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">closest_point_sigma2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span><span class="w"></span>
<span class="linenos">118</span><span class="w">  </span><span class="n">curve_params</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">interior_sigma2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00001</span><span class="p">;</span><span class="w"></span>
<span class="linenos">119</span><span class="w">  </span><span class="n">curve_params</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">smooth_concavity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">120</span><span class="w">  </span><span class="n">curve_params</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">smoothness</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">121</span>
<span class="linenos">122</span><span class="w">  </span><span class="c1">// initialisation (circular)</span>
<span class="linenos">123</span><span class="w">  </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;  curve fitting ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">124</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">on_nurbs</span><span class="o">::</span><span class="n">NurbsDataCurve2d</span><span class="w"> </span><span class="n">curve_data</span><span class="p">;</span><span class="w"></span>
<span class="linenos">125</span><span class="w">  </span><span class="n">curve_data</span><span class="p">.</span><span class="n">interior</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">interior_param</span><span class="p">;</span><span class="w"></span>
<span class="linenos">126</span><span class="w">  </span><span class="n">curve_data</span><span class="p">.</span><span class="n">interior_weight_function</span><span class="p">.</span><span class="n">push_back</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="linenos">127</span><span class="w">  </span><span class="n">ON_NurbsCurve</span><span class="w"> </span><span class="n">curve_nurbs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">on_nurbs</span><span class="o">::</span><span class="n">FittingCurve2dAPDM</span><span class="o">::</span><span class="n">initNurbsCurve2D</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="p">,</span><span class="w"> </span><span class="n">curve_data</span><span class="p">.</span><span class="n">interior</span><span class="p">);</span><span class="w"></span>
<span class="linenos">128</span>
<span class="linenos">129</span><span class="w">  </span><span class="c1">// curve fitting</span>
<span class="linenos">130</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">on_nurbs</span><span class="o">::</span><span class="n">FittingCurve2dASDM</span><span class="w"> </span><span class="n">curve_fit</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">curve_data</span><span class="p">,</span><span class="w"> </span><span class="n">curve_nurbs</span><span class="p">);</span><span class="w"></span>
<span class="linenos">131</span><span class="w">  </span><span class="c1">// curve_fit.setQuiet (false); // enable/disable debug output</span>
<span class="linenos">132</span><span class="w">  </span><span class="n">curve_fit</span><span class="p">.</span><span class="n">fitting</span><span class="w"> </span><span class="p">(</span><span class="n">curve_params</span><span class="p">);</span><span class="w"></span>
<span class="linenos">133</span><span class="w">  </span><span class="n">visualizeCurve</span><span class="w"> </span><span class="p">(</span><span class="n">curve_fit</span><span class="p">.</span><span class="n">m_nurbs</span><span class="p">,</span><span class="w"> </span><span class="n">fit</span><span class="p">.</span><span class="n">m_nurbs</span><span class="p">,</span><span class="w"> </span><span class="n">viewer</span><span class="p">);</span><span class="w"></span>
<span class="linenos">134</span>
<span class="linenos">135</span><span class="w">  </span><span class="c1">// ############################################################################</span>
<span class="linenos">136</span><span class="w">  </span><span class="c1">// triangulation of trimmed surface</span>
<span class="linenos">137</span>
<span class="linenos">138</span><span class="w">  </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;  triangulate trimmed surface ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">139</span><span class="w">  </span><span class="n">viewer</span><span class="p">.</span><span class="n">removePolygonMesh</span><span class="w"> </span><span class="p">(</span><span class="n">mesh_id</span><span class="p">);</span><span class="w"></span>
<span class="linenos">140</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">on_nurbs</span><span class="o">::</span><span class="n">Triangulation</span><span class="o">::</span><span class="n">convertTrimmedSurface2PolygonMesh</span><span class="w"> </span><span class="p">(</span><span class="n">fit</span><span class="p">.</span><span class="n">m_nurbs</span><span class="p">,</span><span class="w"> </span><span class="n">curve_fit</span><span class="p">.</span><span class="n">m_nurbs</span><span class="p">,</span><span class="w"> </span><span class="n">mesh</span><span class="p">,</span><span class="w"></span>
<span class="linenos">141</span><span class="w">                                                                   </span><span class="n">mesh_resolution</span><span class="p">);</span><span class="w"></span>
<span class="linenos">142</span><span class="w">  </span><span class="n">viewer</span><span class="p">.</span><span class="n">addPolygonMesh</span><span class="w"> </span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span><span class="w"> </span><span class="n">mesh_id</span><span class="p">);</span><span class="w"></span>
<span class="linenos">143</span>
<span class="linenos">144</span>
<span class="linenos">145</span><span class="w">  </span><span class="c1">// save trimmed B-spline surface</span>
<span class="linenos">146</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">fit</span><span class="p">.</span><span class="n">m_nurbs</span><span class="p">.</span><span class="n">IsValid</span><span class="p">()</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="linenos">147</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos">148</span><span class="w">    </span><span class="n">ONX_Model</span><span class="w"> </span><span class="n">model</span><span class="p">;</span><span class="w"></span>
<span class="linenos">149</span><span class="w">    </span><span class="n">ONX_Model_Object</span><span class="o">&amp;</span><span class="w"> </span><span class="n">surf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">m_object_table</span><span class="p">.</span><span class="n">AppendNew</span><span class="p">();</span><span class="w"></span>
<span class="linenos">150</span><span class="w">    </span><span class="n">surf</span><span class="p">.</span><span class="n">m_object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ON_NurbsSurface</span><span class="p">(</span><span class="n">fit</span><span class="p">.</span><span class="n">m_nurbs</span><span class="p">);</span><span class="w"></span>
<span class="linenos">151</span><span class="w">    </span><span class="n">surf</span><span class="p">.</span><span class="n">m_bDeleteObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="linenos">152</span><span class="w">    </span><span class="n">surf</span><span class="p">.</span><span class="n">m_attributes</span><span class="p">.</span><span class="n">m_layer_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="linenos">153</span><span class="w">    </span><span class="n">surf</span><span class="p">.</span><span class="n">m_attributes</span><span class="p">.</span><span class="n">m_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;surface&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">154</span>
<span class="linenos">155</span><span class="w">    </span><span class="n">ONX_Model_Object</span><span class="o">&amp;</span><span class="w"> </span><span class="n">curv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">m_object_table</span><span class="p">.</span><span class="n">AppendNew</span><span class="p">();</span><span class="w"></span>
<span class="linenos">156</span><span class="w">    </span><span class="n">curv</span><span class="p">.</span><span class="n">m_object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ON_NurbsCurve</span><span class="p">(</span><span class="n">curve_fit</span><span class="p">.</span><span class="n">m_nurbs</span><span class="p">);</span><span class="w"></span>
<span class="linenos">157</span><span class="w">    </span><span class="n">curv</span><span class="p">.</span><span class="n">m_bDeleteObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="linenos">158</span><span class="w">    </span><span class="n">curv</span><span class="p">.</span><span class="n">m_attributes</span><span class="p">.</span><span class="n">m_layer_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="linenos">159</span><span class="w">    </span><span class="n">curv</span><span class="p">.</span><span class="n">m_attributes</span><span class="p">.</span><span class="n">m_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;trimming curve&quot;</span><span class="p">;</span><span class="w"></span>
<span class="linenos">160</span>
<span class="linenos">161</span><span class="w">    </span><span class="n">model</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="n">file_3dm</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span><span class="w"></span>
<span class="linenos">162</span><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;  model saved: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">file_3dm</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span><span class="w"></span>
<span class="linenos">163</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">164</span>
<span class="linenos">165</span><span class="w">  </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;  ... done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">166</span>
<span class="linenos">167</span><span class="w">  </span><span class="n">viewer</span><span class="p">.</span><span class="n">spin</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="linenos">168</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">169</span><span class="p">}</span><span class="w"></span>
<span class="linenos">170</span>
<span class="linenos">171</span><span class="kt">void</span><span class="w"></span>
<span class="linenos">172</span><span class="nf">PointCloud2Vector3d</span><span class="w"> </span><span class="p">(</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="o">&lt;</span><span class="n">Point</span><span class="o">&gt;::</span><span class="n">Ptr</span><span class="w"> </span><span class="n">cloud</span><span class="p">,</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">on_nurbs</span><span class="o">::</span><span class="n">vector_vec3d</span><span class="w"> </span><span class="o">&amp;</span><span class="n">data</span><span class="p">)</span><span class="w"></span>
<span class="linenos">173</span><span class="p">{</span><span class="w"></span>
<span class="linenos">174</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">cloud</span><span class="o">-&gt;</span><span class="n">size</span><span class="w"> </span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="linenos">175</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos">176</span><span class="w">    </span><span class="n">Point</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cloud</span><span class="o">-&gt;</span><span class="n">at</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="linenos">177</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">std</span><span class="o">::</span><span class="n">isnan</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">std</span><span class="o">::</span><span class="n">isnan</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">std</span><span class="o">::</span><span class="n">isnan</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">z</span><span class="p">))</span><span class="w"></span>
<span class="linenos">178</span><span class="w">      </span><span class="n">data</span><span class="p">.</span><span class="n">push_back</span><span class="w"> </span><span class="p">(</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">z</span><span class="p">));</span><span class="w"></span>
<span class="linenos">179</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">180</span><span class="p">}</span><span class="w"></span>
<span class="linenos">181</span>
<span class="linenos">182</span><span class="kt">void</span><span class="w"></span>
<span class="linenos">183</span><span class="nf">visualizeCurve</span><span class="w"> </span><span class="p">(</span><span class="n">ON_NurbsCurve</span><span class="w"> </span><span class="o">&amp;</span><span class="n">curve</span><span class="p">,</span><span class="w"> </span><span class="n">ON_NurbsSurface</span><span class="w"> </span><span class="o">&amp;</span><span class="n">surface</span><span class="p">,</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">visualization</span><span class="o">::</span><span class="n">PCLVisualizer</span><span class="w"> </span><span class="o">&amp;</span><span class="n">viewer</span><span class="p">)</span><span class="w"></span>
<span class="linenos">184</span><span class="p">{</span><span class="w"></span>
<span class="linenos">185</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZRGB</span><span class="o">&gt;::</span><span class="n">Ptr</span><span class="w"> </span><span class="n">curve_cloud</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZRGB</span><span class="o">&gt;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">186</span>
<span class="linenos">187</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">on_nurbs</span><span class="o">::</span><span class="n">Triangulation</span><span class="o">::</span><span class="n">convertCurve2PointCloud</span><span class="w"> </span><span class="p">(</span><span class="n">curve</span><span class="p">,</span><span class="w"> </span><span class="n">surface</span><span class="p">,</span><span class="w"> </span><span class="n">curve_cloud</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="linenos">188</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">curve_cloud</span><span class="o">-&gt;</span><span class="n">size</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="linenos">189</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos">190</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZRGB</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curve_cloud</span><span class="o">-&gt;</span><span class="n">at</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="linenos">191</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZRGB</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curve_cloud</span><span class="o">-&gt;</span><span class="n">at</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">192</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">ostringstream</span><span class="w"> </span><span class="n">os</span><span class="p">;</span><span class="w"></span>
<span class="linenos">193</span><span class="w">    </span><span class="n">os</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;line&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="linenos">194</span><span class="w">    </span><span class="n">viewer</span><span class="p">.</span><span class="n">removeShape</span><span class="w"> </span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="w"> </span><span class="p">());</span><span class="w"></span>
<span class="linenos">195</span><span class="w">    </span><span class="n">viewer</span><span class="p">.</span><span class="n">addLine</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZRGB</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="w"> </span><span class="n">p2</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="w"> </span><span class="p">());</span><span class="w"></span>
<span class="linenos">196</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">197</span>
<span class="linenos">198</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZRGB</span><span class="o">&gt;::</span><span class="n">Ptr</span><span class="w"> </span><span class="n">curve_cps</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZRGB</span><span class="o">&gt;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">199</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">curve</span><span class="p">.</span><span class="n">CVCount</span><span class="w"> </span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="linenos">200</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos">201</span><span class="w">    </span><span class="n">ON_3dPoint</span><span class="w"> </span><span class="n">p1</span><span class="p">;</span><span class="w"></span>
<span class="linenos">202</span><span class="w">    </span><span class="n">curve</span><span class="p">.</span><span class="n">GetCV</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">p1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">203</span>
<span class="linenos">204</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">pnt</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span><span class="w"></span>
<span class="linenos">205</span><span class="w">    </span><span class="n">surface</span><span class="p">.</span><span class="n">Evaluate</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">p1</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">pnt</span><span class="p">);</span><span class="w"></span>
<span class="linenos">206</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZRGB</span><span class="w"> </span><span class="n">p2</span><span class="p">;</span><span class="w"></span>
<span class="linenos">207</span><span class="w">    </span><span class="n">p2</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="p">(</span><span class="n">pnt</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="linenos">208</span><span class="w">    </span><span class="n">p2</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="p">(</span><span class="n">pnt</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="linenos">209</span><span class="w">    </span><span class="n">p2</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="p">(</span><span class="n">pnt</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span><span class="w"></span>
<span class="linenos">210</span>
<span class="linenos">211</span><span class="w">    </span><span class="n">p2</span><span class="p">.</span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">255</span><span class="p">;</span><span class="w"></span>
<span class="linenos">212</span><span class="w">    </span><span class="n">p2</span><span class="p">.</span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">213</span><span class="w">    </span><span class="n">p2</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">214</span>
<span class="linenos">215</span><span class="w">    </span><span class="n">curve_cps</span><span class="o">-&gt;</span><span class="n">push_back</span><span class="w"> </span><span class="p">(</span><span class="n">p2</span><span class="p">);</span><span class="w"></span>
<span class="linenos">216</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">217</span><span class="w">  </span><span class="n">viewer</span><span class="p">.</span><span class="n">removePointCloud</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;cloud_cps&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">218</span><span class="w">  </span><span class="n">viewer</span><span class="p">.</span><span class="n">addPointCloud</span><span class="w"> </span><span class="p">(</span><span class="n">curve_cps</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cloud_cps&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">219</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="the-explanation">
<h1>The explanation</h1>
<p>Now, let’s break down the code piece by piece.
Lets start with the choice of the parameters for B-spline surface fitting:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">  </span><span class="c1">// parameters</span>
<span class="linenos"> 2</span><span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="nf">order</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 3</span><span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="nf">refinement</span><span class="w"> </span><span class="p">(</span><span class="mi">5</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 4</span><span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="nf">iterations</span><span class="w"> </span><span class="p">(</span><span class="mi">10</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="nf">mesh_resolution</span><span class="w"> </span><span class="p">(</span><span class="mi">256</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">on_nurbs</span><span class="o">::</span><span class="n">FittingSurface</span><span class="o">::</span><span class="n">Parameter</span><span class="w"> </span><span class="n">params</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">  </span><span class="n">params</span><span class="p">.</span><span class="n">interior_smoothness</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.2</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">  </span><span class="n">params</span><span class="p">.</span><span class="n">interior_weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">10</span><span class="w">  </span><span class="n">params</span><span class="p">.</span><span class="n">boundary_smoothness</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.2</span><span class="p">;</span><span class="w"></span>
<span class="linenos">11</span><span class="w">  </span><span class="n">params</span><span class="p">.</span><span class="n">boundary_weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p><em>order</em> is the polynomial order of the B-spline surface.</p></li>
<li><p><em>refinement</em> is the number of refinement iterations, where for each iteration control-points
are inserted, approximately doubling the control points in each parametric direction
of the B-spline surface.</p></li>
<li><p><em>iterations</em> is the number of iterations that are performed after refinement is completed.</p></li>
<li><p><em>mesh_resolution</em> the number of vertices in each parametric direction,
used for triangulation of the B-spline surface.</p></li>
</ul>
<p>Fitting:</p>
<ul class="simple">
<li><p><em>interior_smoothness</em> is the smoothness of the surface interior.</p></li>
<li><p><em>interior_weight</em> is the weight for optimization for the surface interior.</p></li>
<li><p><em>boundary_smoothness</em> is the smoothness of the surface boundary.</p></li>
<li><p><em>boundary_weight</em> is the weight for optimization for the surface boundary.</p></li>
</ul>
<p>Note, that the boundary in this case is not the trimming curve used later on.
The boundary can be used when a point-set exists that defines the boundary. Those points
can be declared in <em>pcl::on_nurbs::NurbsDataSurface::boundary</em>. In that case, when the
<em>boundary_weight</em> is greater than 0.0, the algorithm tries to align the domain boundaries
to these points. In our example we are trimming the surface anyway, so there is no need
for aligning the boundary.</p>
<section id="initialization-of-the-b-spline-surface">
<h2>Initialization of the B-spline surface</h2>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// initialize</span>
<span class="w">  </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;  surface fitting ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">ON_NurbsSurface</span><span class="w"> </span><span class="n">nurbs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">on_nurbs</span><span class="o">::</span><span class="n">FittingSurface</span><span class="o">::</span><span class="n">initNurbsPCABoundingBox</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">data</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">on_nurbs</span><span class="o">::</span><span class="n">FittingSurface</span><span class="w"> </span><span class="nf">fit</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">nurbs</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="c1">//  fit.setQuiet (false); // enable/disable debug output</span>
</pre></div>
</div>
<p>The command <em>initNurbsPCABoundingBox</em> uses PCA to create a coordinate systems, where the principal
eigenvectors point into the direction of the maximum, middle and minimum extension of the point-cloud.
The center of the coordinate system is located at the mean of the points.
To estimate the extension of the B-spline surface domain, a bounding box is computed in the plane formed
by the maximum and middle eigenvectors. That bounding box is used to initialize the B-spline surface with
its minimum number of control points, according to the polynomial degree chosen.</p>
<p>The surface fitting class <em>pcl::on_nurbs::FittingSurface</em> is initialized with the point data and the initial
B-spline.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// mesh for visualization</span>
<span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">PolygonMesh</span><span class="w"> </span><span class="n">mesh</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span><span class="o">&gt;::</span><span class="n">Ptr</span><span class="w"> </span><span class="n">mesh_cloud</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span><span class="o">&gt;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">Vertices</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mesh_vertices</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">mesh_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;mesh_nurbs&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">on_nurbs</span><span class="o">::</span><span class="n">Triangulation</span><span class="o">::</span><span class="n">convertSurface2PolygonMesh</span><span class="w"> </span><span class="p">(</span><span class="n">fit</span><span class="p">.</span><span class="n">m_nurbs</span><span class="p">,</span><span class="w"> </span><span class="n">mesh</span><span class="p">,</span><span class="w"> </span><span class="n">mesh_resolution</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">viewer</span><span class="p">.</span><span class="n">addPolygonMesh</span><span class="w"> </span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span><span class="w"> </span><span class="n">mesh_id</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>The <em>on_nurbs::Triangulation</em> class allows easy conversion between the <em>ON_NurbsSurface</em> and the <em>PolygonMesh</em> class,
for visualization of the B-spline surfaces. Note that NURBS are a generalization of B-splines,
and are therefore a valid container for B-splines, with all control-point weights = 1.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// surface refinement</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">refinement</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">fit</span><span class="p">.</span><span class="n">refine</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">fit</span><span class="p">.</span><span class="n">refine</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">fit</span><span class="p">.</span><span class="n">assemble</span><span class="w"> </span><span class="p">(</span><span class="n">params</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">fit</span><span class="p">.</span><span class="n">solve</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">on_nurbs</span><span class="o">::</span><span class="n">Triangulation</span><span class="o">::</span><span class="n">convertSurface2Vertices</span><span class="w"> </span><span class="p">(</span><span class="n">fit</span><span class="p">.</span><span class="n">m_nurbs</span><span class="p">,</span><span class="w"> </span><span class="n">mesh_cloud</span><span class="p">,</span><span class="w"> </span><span class="n">mesh_vertices</span><span class="p">,</span><span class="w"> </span><span class="n">mesh_resolution</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">viewer</span><span class="p">.</span><span class="n">updatePolygonMesh</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">mesh_cloud</span><span class="p">,</span><span class="w"> </span><span class="n">mesh_vertices</span><span class="p">,</span><span class="w"> </span><span class="n">mesh_id</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">viewer</span><span class="p">.</span><span class="n">spinOnce</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="refinement-and-fitting-of-the-b-spline-surface">
<h2>Refinement and fitting of the B-spline surface</h2>
<p>At this point of the code we have a B-spline surface with minimal number of control points.
Typically they are not enough to represent finer details of the underlying geometry
of the point-cloud. However, if we increase the control-points to our desired level of detail and
subsequently fit the refined B-spline, we run into problems. For robust fitting B-spline surfaces
the rule is:
“The higher the degree of freedom of the B-spline surface, the closer we have to be to the points to be approximated”.</p>
<p>This is the reason why we iteratively increase the degree of freedom by refinement in both directions (line 85-86),
and fit the B-spline surface to the point-cloud, getting closer to the final solution.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// surface fitting with final refinement level</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">iterations</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">fit</span><span class="p">.</span><span class="n">assemble</span><span class="w"> </span><span class="p">(</span><span class="n">params</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">fit</span><span class="p">.</span><span class="n">solve</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">on_nurbs</span><span class="o">::</span><span class="n">Triangulation</span><span class="o">::</span><span class="n">convertSurface2Vertices</span><span class="w"> </span><span class="p">(</span><span class="n">fit</span><span class="p">.</span><span class="n">m_nurbs</span><span class="p">,</span><span class="w"> </span><span class="n">mesh_cloud</span><span class="p">,</span><span class="w"> </span><span class="n">mesh_vertices</span><span class="p">,</span><span class="w"> </span><span class="n">mesh_resolution</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">viewer</span><span class="p">.</span><span class="n">updatePolygonMesh</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">mesh_cloud</span><span class="p">,</span><span class="w"> </span><span class="n">mesh_vertices</span><span class="p">,</span><span class="w"> </span><span class="n">mesh_id</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">viewer</span><span class="p">.</span><span class="n">spinOnce</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>After we reached the final level of refinement, the surface is further fitted to the point-cloud
for a pleasing end result.</p>
</section>
<section id="initialization-of-the-b-spline-curve">
<h2>Initialization of the B-spline curve</h2>
<p>Now that we have the surface fitted to the point-cloud, we want to cut off the overlapping regions of the surface.
To achieve this we project the point-cloud into the parametric domain using the closest points to the B-spline surface.
In this domain of R^2 we perform the weighted B-spline curve fitting, that creates a closed trimming curve that approximately
contains all the points.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// parameters</span>
<span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">on_nurbs</span><span class="o">::</span><span class="n">FittingCurve2dAPDM</span><span class="o">::</span><span class="n">FitParameter</span><span class="w"> </span><span class="n">curve_params</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">curve_params</span><span class="p">.</span><span class="n">addCPsAccuracy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5e-2</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">curve_params</span><span class="p">.</span><span class="n">addCPsIteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">curve_params</span><span class="p">.</span><span class="n">maxCPs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">200</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">curve_params</span><span class="p">.</span><span class="n">accuracy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e-3</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">curve_params</span><span class="p">.</span><span class="n">iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">curve_params</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">closest_point_resolution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">curve_params</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">closest_point_weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">curve_params</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">closest_point_sigma2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">curve_params</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">interior_sigma2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00001</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">curve_params</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">smooth_concavity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">curve_params</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">smoothness</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>The topic of curve fitting goes a bit deeper into the thematics of B-splines. Here we assume that you are
familiar with the concept of B-splines, knot vectors, control-points, and so forth.
Please consider the curve being split into supporting regions which is bound by consecutive knots.
Also note that points that are inside and outside the curve are distinguished.</p>
<ul class="simple">
<li><p><em>addCPsAccuracy</em> the distance of the supporting region of the curve to the closest data points has to be below
this value, otherwise a control point is inserted.</p></li>
<li><p><em>addCPsIteration</em> inner iterations without inserting control points.</p></li>
<li><p><em>maxCPs</em> the maximum total number of control-points.</p></li>
<li><p><em>accuracy</em> the average fitting accuracy of the curve, w.r.t. the supporting regions.</p></li>
<li><p><em>iterations</em> maximum number of iterations performed.</p></li>
<li><p><em>closest_point_resolution</em> number of control points that must lie within each supporting region. (0 turns this constraint off)</p></li>
<li><p><em>closest_point_weight</em> weight for fitting the curve to its closest points.</p></li>
<li><p><em>closest_point_sigma2</em> threshold for closest points (disregard points that are further away from the curve).</p></li>
<li><p><em>interior_sigma2</em> threshold for interior points (disregard points that are further away from and lie within the curve).</p></li>
<li><p><em>smooth_concavity</em> value that leads to inward bending of the curve (0 = no bending; &lt;0 inward bending; &gt;0 outward bending).</p></li>
<li><p><em>smoothness</em> weight of smoothness term.</p></li>
</ul>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// initialisation (circular)</span>
<span class="w">  </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;  curve fitting ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">on_nurbs</span><span class="o">::</span><span class="n">NurbsDataCurve2d</span><span class="w"> </span><span class="n">curve_data</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">curve_data</span><span class="p">.</span><span class="n">interior</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">interior_param</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">curve_data</span><span class="p">.</span><span class="n">interior_weight_function</span><span class="p">.</span><span class="n">push_back</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">ON_NurbsCurve</span><span class="w"> </span><span class="n">curve_nurbs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">on_nurbs</span><span class="o">::</span><span class="n">FittingCurve2dAPDM</span><span class="o">::</span><span class="n">initNurbsCurve2D</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="p">,</span><span class="w"> </span><span class="n">curve_data</span><span class="p">.</span><span class="n">interior</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>The curve is initialized using a minimum number of control points to represent a circle, with the center located
at the mean of the point-cloud and the radius of the maximum distance of a point to the center.
Please note that interior weighting is enabled for all points with the command <em>curve_data.interior_weight_function.push_back (true)</em>.</p>
</section>
<section id="fitting-of-the-b-spline-curve">
<h2>Fitting of the B-spline curve</h2>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// curve fitting</span>
<span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">on_nurbs</span><span class="o">::</span><span class="n">FittingCurve2dASDM</span><span class="w"> </span><span class="nf">curve_fit</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">curve_data</span><span class="p">,</span><span class="w"> </span><span class="n">curve_nurbs</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="c1">// curve_fit.setQuiet (false); // enable/disable debug output</span>
<span class="w">  </span><span class="n">curve_fit</span><span class="p">.</span><span class="n">fitting</span><span class="w"> </span><span class="p">(</span><span class="n">curve_params</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">visualizeCurve</span><span class="w"> </span><span class="p">(</span><span class="n">curve_fit</span><span class="p">.</span><span class="n">m_nurbs</span><span class="p">,</span><span class="w"> </span><span class="n">fit</span><span class="p">.</span><span class="n">m_nurbs</span><span class="p">,</span><span class="w"> </span><span class="n">viewer</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Similar to the surface fitting approach, the curve is iteratively fitted and refined, as shown in the video.
Note how the curve tends to bend inwards at regions where it is not supported by any points.</p>
</section>
<section id="triangulation-of-the-trimmed-b-spline-surface">
<h2>Triangulation of the trimmed B-spline surface</h2>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// triangulation of trimmed surface</span>

<span class="w">  </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;  triangulate trimmed surface ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">viewer</span><span class="p">.</span><span class="n">removePolygonMesh</span><span class="w"> </span><span class="p">(</span><span class="n">mesh_id</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">on_nurbs</span><span class="o">::</span><span class="n">Triangulation</span><span class="o">::</span><span class="n">convertTrimmedSurface2PolygonMesh</span><span class="w"> </span><span class="p">(</span><span class="n">fit</span><span class="p">.</span><span class="n">m_nurbs</span><span class="p">,</span><span class="w"> </span><span class="n">curve_fit</span><span class="p">.</span><span class="n">m_nurbs</span><span class="p">,</span><span class="w"> </span><span class="n">mesh</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                                   </span><span class="n">mesh_resolution</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">viewer</span><span class="p">.</span><span class="n">addPolygonMesh</span><span class="w"> </span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span><span class="w"> </span><span class="n">mesh_id</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>After the curve fitting terminated, our geometric representation consists of a B-spline surface and a closed
B-spline curved, defined within the parametric domain of the B-spline surface. This is called trimmed B-spline surface.
In line 140 we can use the trimmed B-spline to create a triangular mesh. The triangulation algorithm first triangulates
the whole domain and afterwards removes triangles that lie outside of the trimming curve. Vertices of triangles
that intersect the trimming curve are clamped to the curve.</p>
<p>When running this example and switch to wire-frame mode (w), you will notice that the triangles are ordered in
a rectangular way, which is a result of the rectangular domain of the surface.</p>
</section>
</section>
<section id="some-hints">
<h1>Some hints</h1>
<p>Please bear in mind that the robustness of this algorithm heavily depends on the underlying data.
The parameters for B-spline fitting are designed to model the characteristics of this data.</p>
<ul class="simple">
<li><p>If you have holes or steps in your data, you might want to work with lower refinement levels and lower accuracy to
prevent the B-spline from folding and twisting. Moderately increasing of the smoothness might also work.</p></li>
<li><p>Try to introduce as much pre-conditioning and constraints to the parameters. E.g. if you know, that
the trimming curve is rather simple, then limit the number of maximum control points.</p></li>
<li><p>Start simple! Before giving up on gaining control over twisting and bending B-splines, I highly recommend
to start your fitting trials with a small number of control points (low refinement),
low accuracy but also low smoothness (B-splines have implicit smoothing property).</p></li>
</ul>
</section>
<section id="compiling-and-running-the-program">
<h1>Compiling and running the program</h1>
<p>Add the following lines to your CMakeLists.txt file:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span><span class="w"> </span><span class="s">3.5</span><span class="w"> </span><span class="s">FATAL_ERROR</span><span class="p">)</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="nb">project</span><span class="p">(</span><span class="s">bspline_fitting</span><span class="p">)</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="nb">find_package</span><span class="p">(</span><span class="s">PCL</span><span class="w"> </span><span class="s">1.7</span><span class="w"> </span><span class="s">REQUIRED</span><span class="p">)</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="nb">include_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">PCL_INCLUDE_DIRS</span><span class="o">}</span><span class="p">)</span>
<span class="linenos"> 8</span><span class="nb">link_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">PCL_LIBRARY_DIRS</span><span class="o">}</span><span class="p">)</span>
<span class="linenos"> 9</span><span class="nb">add_definitions</span><span class="p">(</span><span class="o">${</span><span class="nv">PCL_DEFINITIONS</span><span class="o">}</span><span class="p">)</span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="nb">add_executable</span> <span class="p">(</span><span class="s">bspline_fitting</span><span class="w"> </span><span class="s">bspline_fitting.cpp</span><span class="p">)</span>
<span class="linenos">12</span><span class="nb">target_link_libraries</span> <span class="p">(</span><span class="s">bspline_fitting</span><span class="w"> </span><span class="o">${</span><span class="nv">PCL_LIBRARIES</span><span class="o">}</span><span class="p">)</span>
</pre></div>
</div>
<p>After you have made the executable, you can run it. Simply do:</p>
<blockquote>
<div><p>$ ./bspline_fitting ${PCL_ROOT}/test/bunny.pcd</p>
</div></blockquote>
</section>
<section id="saving-and-viewing-the-result">
<h1>Saving and viewing the result</h1>
<ul class="simple">
<li><p>Saving as OpenNURBS (3dm) file</p></li>
</ul>
<p>You can save the B-spline surface by using the commands provided by OpenNurbs:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// save trimmed B-spline surface</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">fit</span><span class="p">.</span><span class="n">m_nurbs</span><span class="p">.</span><span class="n">IsValid</span><span class="p">()</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ONX_Model</span><span class="w"> </span><span class="n">model</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">ONX_Model_Object</span><span class="o">&amp;</span><span class="w"> </span><span class="n">surf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">m_object_table</span><span class="p">.</span><span class="n">AppendNew</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">surf</span><span class="p">.</span><span class="n">m_object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ON_NurbsSurface</span><span class="p">(</span><span class="n">fit</span><span class="p">.</span><span class="n">m_nurbs</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">surf</span><span class="p">.</span><span class="n">m_bDeleteObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">surf</span><span class="p">.</span><span class="n">m_attributes</span><span class="p">.</span><span class="n">m_layer_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">surf</span><span class="p">.</span><span class="n">m_attributes</span><span class="p">.</span><span class="n">m_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;surface&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">ONX_Model_Object</span><span class="o">&amp;</span><span class="w"> </span><span class="n">curv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">m_object_table</span><span class="p">.</span><span class="n">AppendNew</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">curv</span><span class="p">.</span><span class="n">m_object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ON_NurbsCurve</span><span class="p">(</span><span class="n">curve_fit</span><span class="p">.</span><span class="n">m_nurbs</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">curv</span><span class="p">.</span><span class="n">m_bDeleteObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">curv</span><span class="p">.</span><span class="n">m_attributes</span><span class="p">.</span><span class="n">m_layer_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">curv</span><span class="p">.</span><span class="n">m_attributes</span><span class="p">.</span><span class="n">m_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;trimming curve&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">model</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="n">file_3dm</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;  model saved: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">file_3dm</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The files generated can be viewed with the pcl/examples/surface/example_nurbs_viewer_surface.cpp.</p>
<ul class="simple">
<li><p>Saving as triangle mesh into a vtk file</p></li>
</ul>
<p>You can save the triangle mesh for example by saving into a VTK file by:</p>
<blockquote>
<div><p>#include &lt;pcl/io/vtk_io.h&gt;
…
pcl::io::saveVTKFile (“mesh.vtk”, mesh);</p>
</div></blockquote>
<p>PCL also provides vtk conversion into other formats (PLY, OBJ).</p>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>