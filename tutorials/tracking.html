<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tracking object in real time &mdash; Point Cloud Library 1.14.1-dev documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> Point Cloud Library
          </a>
              <div class="version">
                1.14.1-dev
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">Tracking object in real time</a></li>
<li><a class="reference internal" href="#details">Details</a></li>
<li><a class="reference internal" href="#the-code">The code</a></li>
<li><a class="reference internal" href="#the-explanation">The explanation</a></li>
<li><a class="reference internal" href="#compiling-and-running-the-program">Compiling and running the program</a></li>
<li><a class="reference internal" href="#more-advanced">More Advanced</a></li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Point Cloud Library</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Tracking object in real time</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="tracking-object-in-real-time">
<span id="tracking"></span><h1>Tracking object in real time</h1>
<p>This tutorial explains 6D object tracking and show example code(tracking_sample.cpp) using pcl::tracking libraries. Implementing this example code, you can see the segment track the target object even if you move tracked object or your sensor device. In example, first, you should initialize tracker and you have to pass target object’s point cloud to tracker so that tracker should know what to track. So, before this tutorial, you need to make segmented model with PCD file beforehand. Setting the model to tracker, it starts tracking the object.</p>
<p>Following figure shows how  looks like when tracking works successfully.</p>
<figure class="align-center" id="id1">
<a class="reference internal image-reference" href="_images/mergePicture.png"><img alt="_images/mergePicture.png" src="_images/mergePicture.png" style="height: 600px;" /></a>
<figcaption>
<p><span class="caption-text">fig1: The blue model tracks the cup successfully with red particles.</span></p>
</figcaption>
</figure>
</section>
<section id="details">
<h1>Details</h1>
<p>The pcl_tracking library contains data structures and mechanism for 3D tracking which uses Particle Filter Algorithm. This tracking will enable you to implement 6D-pose (position and rotation) tracking which is optimized to run in real time.</p>
<dl class="simple">
<dt>At each loop, tracking program proceeds along with following algorithm.(see fig2)</dt><dd><ol class="arabic simple">
<li><p>(At  t = t - 1) At first, using previous Pariticle’s information about position and rotation, it will predict each position and rotation of them at the next frame.</p></li>
<li><p>Next, we calculate weights of those particles with the likelihood formula below.(you can select which likelihood function you use)</p></li>
<li><p>Finally, we use the evaluate function which compares real point cloud data from depth sensor  with the predicted particles, and resample particles.</p></li>
</ol>
</dd>
</dl>
<div class="math">
<p><img src="_images/math/8f95e9050646e9f30266ced46002f5ae3503f324.png" alt="L_j = L_{distance} ( \times L_{color} )

w = \sum{}^{} L_j"/></p>
</div><figure class="align-center" id="id2">
<a class="reference internal image-reference" href="_images/slideCapture.png"><img alt="_images/slideCapture.png" src="_images/slideCapture.png" style="height: 400px;" /></a>
<figcaption>
<p><span class="caption-text">fig2: The process of tracking Particle Filter</span></p>
</figcaption>
</figure>
</section>
<section id="the-code">
<h1>The code</h1>
<p>Create three files,  paste following code with your editor and save it as tracking_sample.cpp.</p>
<p>tracking_sample.cpp</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/point_cloud.h&gt;</span><span class="cp"></span>
<span class="linenos">  2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/point_types.h&gt;</span><span class="cp"></span>
<span class="linenos">  3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/io/openni_grabber.h&gt;</span><span class="cp"></span>
<span class="linenos">  4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/common/centroid.h&gt;</span><span class="cp"></span>
<span class="linenos">  5</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/common/transforms.h&gt;</span><span class="c1"> // for transformPointCloud</span><span class="cp"></span>
<span class="linenos">  6</span>
<span class="linenos">  7</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/visualization/cloud_viewer.h&gt;</span><span class="cp"></span>
<span class="linenos">  8</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/visualization/pcl_visualizer.h&gt;</span><span class="cp"></span>
<span class="linenos">  9</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/io/pcd_io.h&gt;</span><span class="cp"></span>
<span class="linenos"> 10</span>
<span class="linenos"> 11</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/filters/passthrough.h&gt;</span><span class="cp"></span>
<span class="linenos"> 12</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/filters/approximate_voxel_grid.h&gt;</span><span class="cp"></span>
<span class="linenos"> 13</span>
<span class="linenos"> 14</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/tracking/tracking.h&gt;</span><span class="cp"></span>
<span class="linenos"> 15</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/tracking/particle_filter.h&gt;</span><span class="cp"></span>
<span class="linenos"> 16</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/tracking/kld_adaptive_particle_filter_omp.h&gt;</span><span class="cp"></span>
<span class="linenos"> 17</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/tracking/particle_filter_omp.h&gt;</span><span class="cp"></span>
<span class="linenos"> 18</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/tracking/coherence.h&gt;</span><span class="cp"></span>
<span class="linenos"> 19</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/tracking/distance_coherence.h&gt;</span><span class="cp"></span>
<span class="linenos"> 20</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/tracking/approx_nearest_pair_point_cloud_coherence.h&gt;</span><span class="cp"></span>
<span class="linenos"> 21</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pcl/tracking/nearest_pair_point_cloud_coherence.h&gt;</span><span class="cp"></span>
<span class="linenos"> 22</span>
<span class="linenos"> 23</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;boost/format.hpp&gt;</span><span class="cp"></span>
<span class="linenos"> 24</span>
<span class="linenos"> 25</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mutex&gt;</span><span class="cp"></span>
<span class="linenos"> 26</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;thread&gt;</span><span class="cp"></span>
<span class="linenos"> 27</span>
<span class="linenos"> 28</span><span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">pcl</span><span class="o">::</span><span class="nn">tracking</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 29</span><span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">std</span><span class="o">::</span><span class="nn">chrono_literals</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 30</span>
<span class="linenos"> 31</span><span class="k">typedef</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZRGBA</span><span class="w"> </span><span class="n">RefPointType</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 32</span><span class="k">typedef</span><span class="w"> </span><span class="n">ParticleXYZRPY</span><span class="w"> </span><span class="n">ParticleT</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 33</span><span class="k">typedef</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZRGBA</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Cloud</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 34</span><span class="k">typedef</span><span class="w"> </span><span class="n">Cloud</span><span class="o">::</span><span class="n">Ptr</span><span class="w"> </span><span class="n">CloudPtr</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 35</span><span class="k">typedef</span><span class="w"> </span><span class="n">Cloud</span><span class="o">::</span><span class="n">ConstPtr</span><span class="w"> </span><span class="n">CloudConstPtr</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 36</span><span class="k">typedef</span><span class="w"> </span><span class="n">ParticleFilterTracker</span><span class="o">&lt;</span><span class="n">RefPointType</span><span class="p">,</span><span class="w"> </span><span class="n">ParticleT</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ParticleFilter</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 37</span>
<span class="linenos"> 38</span><span class="n">CloudPtr</span><span class="w"> </span><span class="n">cloud_pass_</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 39</span><span class="n">CloudPtr</span><span class="w"> </span><span class="n">cloud_pass_downsampled_</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 40</span><span class="n">CloudPtr</span><span class="w"> </span><span class="n">target_cloud</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 41</span>
<span class="linenos"> 42</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="w"> </span><span class="n">mtx_</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 43</span><span class="n">ParticleFilter</span><span class="o">::</span><span class="n">Ptr</span><span class="w"> </span><span class="n">tracker_</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 44</span><span class="kt">bool</span><span class="w"> </span><span class="n">new_cloud_</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 45</span><span class="kt">double</span><span class="w"> </span><span class="n">downsampling_grid_size_</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 46</span><span class="kt">int</span><span class="w"> </span><span class="n">counter</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 47</span>
<span class="linenos"> 48</span>
<span class="linenos"> 49</span><span class="c1">//Filter along a specified dimension</span>
<span class="linenos"> 50</span><span class="kt">void</span><span class="w"> </span><span class="nf">filterPassThrough</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">CloudConstPtr</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cloud</span><span class="p">,</span><span class="w"> </span><span class="n">Cloud</span><span class="w"> </span><span class="o">&amp;</span><span class="n">result</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 51</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 52</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">PassThrough</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZRGBA</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pass</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 53</span><span class="w">  </span><span class="n">pass</span><span class="p">.</span><span class="n">setFilterFieldName</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;z&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 54</span><span class="w">  </span><span class="n">pass</span><span class="p">.</span><span class="n">setFilterLimits</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">10.0</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 55</span><span class="w">  </span><span class="n">pass</span><span class="p">.</span><span class="n">setKeepOrganized</span><span class="w"> </span><span class="p">(</span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 56</span><span class="w">  </span><span class="n">pass</span><span class="p">.</span><span class="n">setInputCloud</span><span class="w"> </span><span class="p">(</span><span class="n">cloud</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 57</span><span class="w">  </span><span class="n">pass</span><span class="p">.</span><span class="n">filter</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 58</span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 59</span>
<span class="linenos"> 60</span>
<span class="linenos"> 61</span><span class="kt">void</span><span class="w"> </span><span class="nf">gridSampleApprox</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">CloudConstPtr</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cloud</span><span class="p">,</span><span class="w"> </span><span class="n">Cloud</span><span class="w"> </span><span class="o">&amp;</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">leaf_size</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 62</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 63</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">ApproximateVoxelGrid</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZRGBA</span><span class="o">&gt;</span><span class="w"> </span><span class="n">grid</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 64</span><span class="w">  </span><span class="n">grid</span><span class="p">.</span><span class="n">setLeafSize</span><span class="w"> </span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">leaf_size</span><span class="p">),</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">leaf_size</span><span class="p">),</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">leaf_size</span><span class="p">));</span><span class="w"></span>
<span class="linenos"> 65</span><span class="w">  </span><span class="n">grid</span><span class="p">.</span><span class="n">setInputCloud</span><span class="w"> </span><span class="p">(</span><span class="n">cloud</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 66</span><span class="w">  </span><span class="n">grid</span><span class="p">.</span><span class="n">filter</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 67</span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 68</span>
<span class="linenos"> 69</span>
<span class="linenos"> 70</span><span class="c1">//Draw the current particles</span>
<span class="linenos"> 71</span><span class="kt">bool</span><span class="w"></span>
<span class="linenos"> 72</span><span class="nf">drawParticles</span><span class="w"> </span><span class="p">(</span><span class="n">pcl</span><span class="o">::</span><span class="n">visualization</span><span class="o">::</span><span class="n">PCLVisualizer</span><span class="o">&amp;</span><span class="w"> </span><span class="n">viz</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 73</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 74</span><span class="w">  </span><span class="n">ParticleFilter</span><span class="o">::</span><span class="n">PointCloudStatePtr</span><span class="w"> </span><span class="n">particles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">getParticles</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="linenos"> 75</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">particles</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">new_cloud_</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 76</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 77</span><span class="w">      </span><span class="c1">//Set pointCloud with particle&#39;s points</span>
<span class="linenos"> 78</span><span class="w">      </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span><span class="o">&gt;::</span><span class="n">Ptr</span><span class="w"> </span><span class="n">particle_cloud</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span><span class="o">&gt;</span><span class="w"> </span><span class="p">());</span><span class="w"></span>
<span class="linenos"> 79</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">particle</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">particles</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 80</span><span class="w">	</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 81</span><span class="w">	  </span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span><span class="w"> </span><span class="n">point</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 82</span><span class="w">          </span>
<span class="linenos"> 83</span><span class="w">	  </span><span class="n">point</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particle</span><span class="p">.</span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 84</span><span class="w">	  </span><span class="n">point</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particle</span><span class="p">.</span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 85</span><span class="w">	  </span><span class="n">point</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particle</span><span class="p">.</span><span class="n">z</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 86</span><span class="w">	  </span><span class="n">particle_cloud</span><span class="o">-&gt;</span><span class="n">push_back</span><span class="w"> </span><span class="p">(</span><span class="n">point</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 87</span><span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 88</span>
<span class="linenos"> 89</span><span class="w">      </span><span class="c1">//Draw red particles </span>
<span class="linenos"> 90</span><span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 91</span><span class="w">	</span><span class="n">pcl</span><span class="o">::</span><span class="n">visualization</span><span class="o">::</span><span class="n">PointCloudColorHandlerCustom</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span><span class="o">&gt;</span><span class="w"> </span><span class="n">red_color</span><span class="w"> </span><span class="p">(</span><span class="n">particle_cloud</span><span class="p">,</span><span class="w"> </span><span class="mi">250</span><span class="p">,</span><span class="w"> </span><span class="mi">99</span><span class="p">,</span><span class="w"> </span><span class="mi">71</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 92</span>
<span class="linenos"> 93</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">viz</span><span class="p">.</span><span class="n">updatePointCloud</span><span class="w"> </span><span class="p">(</span><span class="n">particle_cloud</span><span class="p">,</span><span class="w"> </span><span class="n">red_color</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;particle cloud&quot;</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 94</span><span class="w">	  </span><span class="n">viz</span><span class="p">.</span><span class="n">addPointCloud</span><span class="w"> </span><span class="p">(</span><span class="n">particle_cloud</span><span class="p">,</span><span class="w"> </span><span class="n">red_color</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;particle cloud&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 95</span><span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 96</span><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 97</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 98</span><span class="w">  </span><span class="k">else</span><span class="w"></span>
<span class="linenos"> 99</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">100</span><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="linenos">101</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">102</span><span class="p">}</span><span class="w"></span>
<span class="linenos">103</span>
<span class="linenos">104</span><span class="c1">//Draw model reference point cloud</span>
<span class="linenos">105</span><span class="kt">void</span><span class="w"></span>
<span class="linenos">106</span><span class="nf">drawResult</span><span class="w"> </span><span class="p">(</span><span class="n">pcl</span><span class="o">::</span><span class="n">visualization</span><span class="o">::</span><span class="n">PCLVisualizer</span><span class="o">&amp;</span><span class="w"> </span><span class="n">viz</span><span class="p">)</span><span class="w"></span>
<span class="linenos">107</span><span class="p">{</span><span class="w"></span>
<span class="linenos">108</span><span class="w">  </span><span class="n">ParticleXYZRPY</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">getResult</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="linenos">109</span><span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Affine3f</span><span class="w"> </span><span class="n">transformation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">toEigenMatrix</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">);</span><span class="w"></span>
<span class="linenos">110</span>
<span class="linenos">111</span><span class="w">  </span><span class="c1">//move close to camera a little for better visualization</span>
<span class="linenos">112</span><span class="w">  </span><span class="n">transformation</span><span class="p">.</span><span class="n">translation</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3f</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0f</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.005f</span><span class="p">);</span><span class="w"></span>
<span class="linenos">113</span><span class="w">  </span><span class="n">CloudPtr</span><span class="w"> </span><span class="n">result_cloud</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Cloud</span><span class="w"> </span><span class="p">());</span><span class="w"></span>
<span class="linenos">114</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">transformPointCloud</span><span class="o">&lt;</span><span class="n">RefPointType</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">getReferenceCloud</span><span class="w"> </span><span class="p">()),</span><span class="w"> </span><span class="o">*</span><span class="n">result_cloud</span><span class="p">,</span><span class="w"> </span><span class="n">transformation</span><span class="p">);</span><span class="w"></span>
<span class="linenos">115</span>
<span class="linenos">116</span><span class="w">  </span><span class="c1">//Draw blue model reference point cloud</span>
<span class="linenos">117</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="linenos">118</span><span class="w">    </span><span class="n">pcl</span><span class="o">::</span><span class="n">visualization</span><span class="o">::</span><span class="n">PointCloudColorHandlerCustom</span><span class="o">&lt;</span><span class="n">RefPointType</span><span class="o">&gt;</span><span class="w"> </span><span class="n">blue_color</span><span class="w"> </span><span class="p">(</span><span class="n">result_cloud</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">);</span><span class="w"></span>
<span class="linenos">119</span>
<span class="linenos">120</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">viz</span><span class="p">.</span><span class="n">updatePointCloud</span><span class="w"> </span><span class="p">(</span><span class="n">result_cloud</span><span class="p">,</span><span class="w"> </span><span class="n">blue_color</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;resultcloud&quot;</span><span class="p">))</span><span class="w"></span>
<span class="linenos">121</span><span class="w">      </span><span class="n">viz</span><span class="p">.</span><span class="n">addPointCloud</span><span class="w"> </span><span class="p">(</span><span class="n">result_cloud</span><span class="p">,</span><span class="w"> </span><span class="n">blue_color</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;resultcloud&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">122</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">123</span><span class="p">}</span><span class="w"></span>
<span class="linenos">124</span>
<span class="linenos">125</span><span class="c1">//visualization&#39;s callback function</span>
<span class="linenos">126</span><span class="kt">void</span><span class="w"></span>
<span class="linenos">127</span><span class="nf">viz_cb</span><span class="w"> </span><span class="p">(</span><span class="n">pcl</span><span class="o">::</span><span class="n">visualization</span><span class="o">::</span><span class="n">PCLVisualizer</span><span class="o">&amp;</span><span class="w"> </span><span class="n">viz</span><span class="p">)</span><span class="w"></span>
<span class="linenos">128</span><span class="p">{</span><span class="w"></span>
<span class="linenos">129</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="p">(</span><span class="n">mtx_</span><span class="p">);</span><span class="w"></span>
<span class="linenos">130</span><span class="w">    </span>
<span class="linenos">131</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cloud_pass_</span><span class="p">)</span><span class="w"></span>
<span class="linenos">132</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">133</span><span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="mi">1</span><span class="n">s</span><span class="p">);</span><span class="w"></span>
<span class="linenos">134</span><span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="linenos">135</span><span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="linenos">136</span>
<span class="linenos">137</span><span class="w">  </span><span class="c1">//Draw downsampled point cloud from sensor    </span>
<span class="linenos">138</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">new_cloud_</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cloud_pass_downsampled_</span><span class="p">)</span><span class="w"></span>
<span class="linenos">139</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">140</span><span class="w">      </span><span class="n">CloudPtr</span><span class="w"> </span><span class="n">cloud_pass</span><span class="p">;</span><span class="w"></span>
<span class="linenos">141</span><span class="w">      </span><span class="n">cloud_pass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cloud_pass_downsampled_</span><span class="p">;</span><span class="w"></span>
<span class="linenos">142</span><span class="w">    </span>
<span class="linenos">143</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">viz</span><span class="p">.</span><span class="n">updatePointCloud</span><span class="w"> </span><span class="p">(</span><span class="n">cloud_pass</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cloudpass&quot;</span><span class="p">))</span><span class="w"></span>
<span class="linenos">144</span><span class="w">	</span><span class="p">{</span><span class="w"></span>
<span class="linenos">145</span><span class="w">	  </span><span class="n">viz</span><span class="p">.</span><span class="n">addPointCloud</span><span class="w"> </span><span class="p">(</span><span class="n">cloud_pass</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cloudpass&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">146</span><span class="w">	  </span><span class="n">viz</span><span class="p">.</span><span class="n">resetCameraViewpoint</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;cloudpass&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">147</span><span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="linenos">148</span><span class="w">      </span><span class="kt">bool</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">drawParticles</span><span class="w"> </span><span class="p">(</span><span class="n">viz</span><span class="p">);</span><span class="w"></span>
<span class="linenos">149</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"></span>
<span class="linenos">150</span><span class="w">        </span><span class="n">drawResult</span><span class="w"> </span><span class="p">(</span><span class="n">viz</span><span class="p">);</span><span class="w"></span>
<span class="linenos">151</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">152</span><span class="w">  </span><span class="n">new_cloud_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="linenos">153</span><span class="p">}</span><span class="w"></span>
<span class="linenos">154</span>
<span class="linenos">155</span><span class="c1">//OpenNI Grabber&#39;s cloud Callback function</span>
<span class="linenos">156</span><span class="kt">void</span><span class="w"></span>
<span class="linenos">157</span><span class="nf">cloud_cb</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">CloudConstPtr</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cloud</span><span class="p">)</span><span class="w"></span>
<span class="linenos">158</span><span class="p">{</span><span class="w"></span>
<span class="linenos">159</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="p">(</span><span class="n">mtx_</span><span class="p">);</span><span class="w"></span>
<span class="linenos">160</span><span class="w">  </span><span class="n">cloud_pass_</span><span class="p">.</span><span class="n">reset</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Cloud</span><span class="p">);</span><span class="w"></span>
<span class="linenos">161</span><span class="w">  </span><span class="n">cloud_pass_downsampled_</span><span class="p">.</span><span class="n">reset</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Cloud</span><span class="p">);</span><span class="w"></span>
<span class="linenos">162</span><span class="w">  </span><span class="n">filterPassThrough</span><span class="w"> </span><span class="p">(</span><span class="n">cloud</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">cloud_pass_</span><span class="p">);</span><span class="w"></span>
<span class="linenos">163</span><span class="w">  </span><span class="n">gridSampleApprox</span><span class="w"> </span><span class="p">(</span><span class="n">cloud_pass_</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">cloud_pass_downsampled_</span><span class="p">,</span><span class="w"> </span><span class="n">downsampling_grid_size_</span><span class="p">);</span><span class="w"></span>
<span class="linenos">164</span>
<span class="linenos">165</span><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">){</span><span class="w"></span>
<span class="linenos">166</span><span class="w">	</span><span class="n">counter</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="linenos">167</span><span class="w">  </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="linenos">168</span><span class="w">  	</span><span class="c1">//Track the object</span>
<span class="linenos">169</span><span class="w">	</span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">setInputCloud</span><span class="w"> </span><span class="p">(</span><span class="n">cloud_pass_downsampled_</span><span class="p">);</span><span class="w"></span>
<span class="linenos">170</span><span class="w">	</span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">compute</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="linenos">171</span><span class="w">	</span><span class="n">new_cloud_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="linenos">172</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">173</span><span class="p">}</span><span class="w"></span>
<span class="linenos">174</span>
<span class="linenos">175</span><span class="kt">int</span><span class="w"></span>
<span class="linenos">176</span><span class="nf">main</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span><span class="w"></span>
<span class="linenos">177</span><span class="p">{</span><span class="w"></span>
<span class="linenos">178</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"></span>
<span class="linenos">179</span><span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="linenos">180</span><span class="w">      </span><span class="n">PCL_WARN</span><span class="p">(</span><span class="s">&quot;Please set device_id pcd_filename(e.g. $ %s &#39;#1&#39; sample.pcd)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="linenos">181</span><span class="w">      </span><span class="n">exit</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">182</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">183</span>
<span class="linenos">184</span><span class="w">  </span><span class="c1">//read pcd file</span>
<span class="linenos">185</span><span class="w">  </span><span class="n">target_cloud</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Cloud</span><span class="p">());</span><span class="w"></span>
<span class="linenos">186</span><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">pcl</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">loadPCDFile</span><span class="w"> </span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="o">*</span><span class="n">target_cloud</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">){</span><span class="w"></span>
<span class="linenos">187</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;pcd file not found&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="linenos">188</span><span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">189</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="linenos">190</span>
<span class="linenos">191</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">device_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w">  </span>
<span class="linenos">192</span>
<span class="linenos">193</span><span class="w">  </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">194</span>
<span class="linenos">195</span><span class="w">  </span><span class="c1">//Set parameters</span>
<span class="linenos">196</span><span class="w">  </span><span class="n">new_cloud_</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="linenos">197</span><span class="w">  </span><span class="n">downsampling_grid_size_</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">0.002</span><span class="p">;</span><span class="w"></span>
<span class="linenos">198</span>
<span class="linenos">199</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">default_step_covariance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mf">0.015</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.015</span><span class="p">);</span><span class="w"></span>
<span class="linenos">200</span><span class="w">  </span><span class="n">default_step_covariance</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mf">40.0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">201</span><span class="w">  </span><span class="n">default_step_covariance</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mf">40.0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">202</span><span class="w">  </span><span class="n">default_step_covariance</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mf">40.0</span><span class="p">;</span><span class="w"></span>
<span class="linenos">203</span>
<span class="linenos">204</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">initial_noise_covariance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mf">0.00001</span><span class="p">);</span><span class="w"></span>
<span class="linenos">205</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">default_initial_mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span><span class="w"></span>
<span class="linenos">206</span>
<span class="linenos">207</span><span class="w">  </span><span class="n">KLDAdaptiveParticleFilterOMPTracker</span><span class="o">&lt;</span><span class="n">RefPointType</span><span class="p">,</span><span class="w"> </span><span class="n">ParticleT</span><span class="o">&gt;::</span><span class="n">Ptr</span><span class="w"> </span><span class="n">tracker</span><span class="w"></span>
<span class="linenos">208</span><span class="w">    </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">KLDAdaptiveParticleFilterOMPTracker</span><span class="o">&lt;</span><span class="n">RefPointType</span><span class="p">,</span><span class="w"> </span><span class="n">ParticleT</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="mi">8</span><span class="p">));</span><span class="w"></span>
<span class="linenos">209</span>
<span class="linenos">210</span><span class="w">  </span><span class="n">ParticleT</span><span class="w"> </span><span class="n">bin_size</span><span class="p">;</span><span class="w"></span>
<span class="linenos">211</span><span class="w">  </span><span class="n">bin_size</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1f</span><span class="p">;</span><span class="w"></span>
<span class="linenos">212</span><span class="w">  </span><span class="n">bin_size</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1f</span><span class="p">;</span><span class="w"></span>
<span class="linenos">213</span><span class="w">  </span><span class="n">bin_size</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1f</span><span class="p">;</span><span class="w"></span>
<span class="linenos">214</span><span class="w">  </span><span class="n">bin_size</span><span class="p">.</span><span class="n">roll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1f</span><span class="p">;</span><span class="w"></span>
<span class="linenos">215</span><span class="w">  </span><span class="n">bin_size</span><span class="p">.</span><span class="n">pitch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1f</span><span class="p">;</span><span class="w"></span>
<span class="linenos">216</span><span class="w">  </span><span class="n">bin_size</span><span class="p">.</span><span class="n">yaw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1f</span><span class="p">;</span><span class="w"></span>
<span class="linenos">217</span>
<span class="linenos">218</span>
<span class="linenos">219</span><span class="w">  </span><span class="c1">//Set all parameters for  KLDAdaptiveParticleFilterOMPTracker</span>
<span class="linenos">220</span><span class="w">  </span><span class="n">tracker</span><span class="o">-&gt;</span><span class="n">setMaximumParticleNum</span><span class="w"> </span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span><span class="w"></span>
<span class="linenos">221</span><span class="w">  </span><span class="n">tracker</span><span class="o">-&gt;</span><span class="n">setDelta</span><span class="w"> </span><span class="p">(</span><span class="mf">0.99</span><span class="p">);</span><span class="w"></span>
<span class="linenos">222</span><span class="w">  </span><span class="n">tracker</span><span class="o">-&gt;</span><span class="n">setEpsilon</span><span class="w"> </span><span class="p">(</span><span class="mf">0.2</span><span class="p">);</span><span class="w"></span>
<span class="linenos">223</span><span class="w">  </span><span class="n">tracker</span><span class="o">-&gt;</span><span class="n">setBinSize</span><span class="w"> </span><span class="p">(</span><span class="n">bin_size</span><span class="p">);</span><span class="w"></span>
<span class="linenos">224</span>
<span class="linenos">225</span><span class="w">  </span><span class="c1">//Set all parameters for  ParticleFilter</span>
<span class="linenos">226</span><span class="w">  </span><span class="n">tracker_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tracker</span><span class="p">;</span><span class="w"></span>
<span class="linenos">227</span><span class="w">  </span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">setTrans</span><span class="w"> </span><span class="p">(</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Affine3f</span><span class="o">::</span><span class="n">Identity</span><span class="w"> </span><span class="p">());</span><span class="w"></span>
<span class="linenos">228</span><span class="w">  </span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">setStepNoiseCovariance</span><span class="w"> </span><span class="p">(</span><span class="n">default_step_covariance</span><span class="p">);</span><span class="w"></span>
<span class="linenos">229</span><span class="w">  </span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">setInitialNoiseCovariance</span><span class="w"> </span><span class="p">(</span><span class="n">initial_noise_covariance</span><span class="p">);</span><span class="w"></span>
<span class="linenos">230</span><span class="w">  </span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">setInitialNoiseMean</span><span class="w"> </span><span class="p">(</span><span class="n">default_initial_mean</span><span class="p">);</span><span class="w"></span>
<span class="linenos">231</span><span class="w">  </span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">setIterationNum</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="linenos">232</span><span class="w">  </span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">setParticleNum</span><span class="w"> </span><span class="p">(</span><span class="mi">600</span><span class="p">);</span><span class="w"></span>
<span class="linenos">233</span><span class="w">  </span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">setResampleLikelihoodThr</span><span class="p">(</span><span class="mf">0.00</span><span class="p">);</span><span class="w"></span>
<span class="linenos">234</span><span class="w">  </span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">setUseNormal</span><span class="w"> </span><span class="p">(</span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
<span class="linenos">235</span>
<span class="linenos">236</span>
<span class="linenos">237</span><span class="w">  </span><span class="c1">//Setup coherence object for tracking</span>
<span class="linenos">238</span><span class="w">  </span><span class="n">ApproxNearestPairPointCloudCoherence</span><span class="o">&lt;</span><span class="n">RefPointType</span><span class="o">&gt;::</span><span class="n">Ptr</span><span class="w"> </span><span class="n">coherence</span><span class="w"></span>
<span class="linenos">239</span><span class="w">    </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ApproxNearestPairPointCloudCoherence</span><span class="o">&lt;</span><span class="n">RefPointType</span><span class="o">&gt;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">240</span>
<span class="linenos">241</span><span class="w">  </span><span class="n">DistanceCoherence</span><span class="o">&lt;</span><span class="n">RefPointType</span><span class="o">&gt;::</span><span class="n">Ptr</span><span class="w"> </span><span class="n">distance_coherence</span><span class="w"></span>
<span class="linenos">242</span><span class="w">    </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">DistanceCoherence</span><span class="o">&lt;</span><span class="n">RefPointType</span><span class="o">&gt;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">243</span><span class="w">  </span><span class="n">coherence</span><span class="o">-&gt;</span><span class="n">addPointCoherence</span><span class="w"> </span><span class="p">(</span><span class="n">distance_coherence</span><span class="p">);</span><span class="w"></span>
<span class="linenos">244</span>
<span class="linenos">245</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">search</span><span class="o">::</span><span class="n">Octree</span><span class="o">&lt;</span><span class="n">RefPointType</span><span class="o">&gt;::</span><span class="n">Ptr</span><span class="w"> </span><span class="n">search</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">search</span><span class="o">::</span><span class="n">Octree</span><span class="o">&lt;</span><span class="n">RefPointType</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="mf">0.01</span><span class="p">));</span><span class="w"></span>
<span class="linenos">246</span><span class="w">  </span><span class="n">coherence</span><span class="o">-&gt;</span><span class="n">setSearchMethod</span><span class="w"> </span><span class="p">(</span><span class="n">search</span><span class="p">);</span><span class="w"></span>
<span class="linenos">247</span><span class="w">  </span><span class="n">coherence</span><span class="o">-&gt;</span><span class="n">setMaximumDistance</span><span class="w"> </span><span class="p">(</span><span class="mf">0.01</span><span class="p">);</span><span class="w"></span>
<span class="linenos">248</span>
<span class="linenos">249</span><span class="w">  </span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">setCloudCoherence</span><span class="w"> </span><span class="p">(</span><span class="n">coherence</span><span class="p">);</span><span class="w"></span>
<span class="linenos">250</span>
<span class="linenos">251</span><span class="w">  </span><span class="c1">//prepare the model of tracker&#39;s target</span>
<span class="linenos">252</span><span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector4f</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w"></span>
<span class="linenos">253</span><span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Affine3f</span><span class="w"> </span><span class="n">trans</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Affine3f</span><span class="o">::</span><span class="n">Identity</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="linenos">254</span><span class="w">  </span><span class="n">CloudPtr</span><span class="w"> </span><span class="n">transed_ref</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Cloud</span><span class="p">);</span><span class="w"></span>
<span class="linenos">255</span><span class="w">  </span><span class="n">CloudPtr</span><span class="w"> </span><span class="n">transed_ref_downsampled</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Cloud</span><span class="p">);</span><span class="w"></span>
<span class="linenos">256</span>
<span class="linenos">257</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">compute3DCentroid</span><span class="o">&lt;</span><span class="n">RefPointType</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">target_cloud</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">);</span><span class="w"></span>
<span class="linenos">258</span><span class="w">  </span><span class="n">trans</span><span class="p">.</span><span class="n">translation</span><span class="w"> </span><span class="p">().</span><span class="n">matrix</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3f</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span><span class="w"></span>
<span class="linenos">259</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">transformPointCloud</span><span class="o">&lt;</span><span class="n">RefPointType</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">target_cloud</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">transed_ref</span><span class="p">,</span><span class="w"> </span><span class="n">trans</span><span class="p">.</span><span class="n">inverse</span><span class="p">());</span><span class="w"></span>
<span class="linenos">260</span><span class="w">  </span><span class="n">gridSampleApprox</span><span class="w"> </span><span class="p">(</span><span class="n">transed_ref</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">transed_ref_downsampled</span><span class="p">,</span><span class="w"> </span><span class="n">downsampling_grid_size_</span><span class="p">);</span><span class="w"></span>
<span class="linenos">261</span>
<span class="linenos">262</span><span class="w">  </span><span class="c1">//set reference model and trans</span>
<span class="linenos">263</span><span class="w">  </span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">setReferenceCloud</span><span class="w"> </span><span class="p">(</span><span class="n">transed_ref_downsampled</span><span class="p">);</span><span class="w"></span>
<span class="linenos">264</span><span class="w">  </span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">setTrans</span><span class="w"> </span><span class="p">(</span><span class="n">trans</span><span class="p">);</span><span class="w"></span>
<span class="linenos">265</span>
<span class="linenos">266</span><span class="w">  </span><span class="c1">//Setup OpenNIGrabber and viewer</span>
<span class="linenos">267</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">visualization</span><span class="o">::</span><span class="n">CloudViewer</span><span class="o">*</span><span class="w"> </span><span class="n">viewer_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">visualization</span><span class="o">::</span><span class="n">CloudViewer</span><span class="p">(</span><span class="s">&quot;PCL OpenNI Tracking Viewer&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">268</span><span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">Grabber</span><span class="o">*</span><span class="w"> </span><span class="n">interface</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">OpenNIGrabber</span><span class="w"> </span><span class="p">(</span><span class="n">device_id</span><span class="p">);</span><span class="w"></span>
<span class="linenos">269</span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">CloudConstPtr</span><span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cloud_cb</span><span class="p">;</span><span class="w"></span>
<span class="linenos">270</span><span class="w">  </span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">registerCallback</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="p">);</span><span class="w"></span>
<span class="linenos">271</span>
<span class="linenos">272</span><span class="w">  </span><span class="n">viewer_</span><span class="o">-&gt;</span><span class="n">runOnVisualizationThread</span><span class="w"> </span><span class="p">(</span><span class="n">viz_cb</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;viz_cb&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">273</span>
<span class="linenos">274</span><span class="w">  </span><span class="c1">//Start viewer and object tracking</span>
<span class="linenos">275</span><span class="w">  </span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">();</span><span class="w"></span>
<span class="linenos">276</span><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">viewer_</span><span class="o">-&gt;</span><span class="n">wasStopped</span><span class="w"> </span><span class="p">())</span><span class="w"></span>
<span class="linenos">277</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="mi">1</span><span class="n">s</span><span class="p">);</span><span class="w"></span>
<span class="linenos">278</span><span class="w">  </span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">();</span><span class="w"></span>
<span class="linenos">279</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="the-explanation">
<h1>The explanation</h1>
<p>Now, let’s break down the code piece by piece.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">//Set all parameters for  KLDAdaptiveParticleFilterOMPTracker</span>
<span class="w">  </span><span class="n">tracker</span><span class="o">-&gt;</span><span class="n">setMaximumParticleNum</span><span class="w"> </span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">tracker</span><span class="o">-&gt;</span><span class="n">setDelta</span><span class="w"> </span><span class="p">(</span><span class="mf">0.99</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">tracker</span><span class="o">-&gt;</span><span class="n">setEpsilon</span><span class="w"> </span><span class="p">(</span><span class="mf">0.2</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">tracker</span><span class="o">-&gt;</span><span class="n">setBinSize</span><span class="w"> </span><span class="p">(</span><span class="n">bin_size</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="c1">//Set all parameters for  ParticleFilter</span>
<span class="w">  </span><span class="n">tracker_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tracker</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">setTrans</span><span class="w"> </span><span class="p">(</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Affine3f</span><span class="o">::</span><span class="n">Identity</span><span class="w"> </span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">setStepNoiseCovariance</span><span class="w"> </span><span class="p">(</span><span class="n">default_step_covariance</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">setInitialNoiseCovariance</span><span class="w"> </span><span class="p">(</span><span class="n">initial_noise_covariance</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">setInitialNoiseMean</span><span class="w"> </span><span class="p">(</span><span class="n">default_initial_mean</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">setIterationNum</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">setParticleNum</span><span class="w"> </span><span class="p">(</span><span class="mi">600</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">setResampleLikelihoodThr</span><span class="p">(</span><span class="mf">0.00</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">setUseNormal</span><span class="w"> </span><span class="p">(</span><span class="nb">false</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>First, in main function, these lines set the parameters for tracking.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">//Setup coherence object for tracking</span>
<span class="w">  </span><span class="n">ApproxNearestPairPointCloudCoherence</span><span class="o">&lt;</span><span class="n">RefPointType</span><span class="o">&gt;::</span><span class="n">Ptr</span><span class="w"> </span><span class="n">coherence</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ApproxNearestPairPointCloudCoherence</span><span class="o">&lt;</span><span class="n">RefPointType</span><span class="o">&gt;</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">DistanceCoherence</span><span class="o">&lt;</span><span class="n">RefPointType</span><span class="o">&gt;::</span><span class="n">Ptr</span><span class="w"> </span><span class="n">distance_coherence</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">DistanceCoherence</span><span class="o">&lt;</span><span class="n">RefPointType</span><span class="o">&gt;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">coherence</span><span class="o">-&gt;</span><span class="n">addPointCoherence</span><span class="w"> </span><span class="p">(</span><span class="n">distance_coherence</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">search</span><span class="o">::</span><span class="n">Octree</span><span class="o">&lt;</span><span class="n">RefPointType</span><span class="o">&gt;::</span><span class="n">Ptr</span><span class="w"> </span><span class="n">search</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">pcl</span><span class="o">::</span><span class="n">search</span><span class="o">::</span><span class="n">Octree</span><span class="o">&lt;</span><span class="n">RefPointType</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="mf">0.01</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="n">coherence</span><span class="o">-&gt;</span><span class="n">setSearchMethod</span><span class="w"> </span><span class="p">(</span><span class="n">search</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">coherence</span><span class="o">-&gt;</span><span class="n">setMaximumDistance</span><span class="w"> </span><span class="p">(</span><span class="mf">0.01</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">setCloudCoherence</span><span class="w"> </span><span class="p">(</span><span class="n">coherence</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Here, we set likelihood function which tracker use when calculate weights.  You can add more likelihood function as you like. By default, there are normals likelihood and color likelihood functions. When you want to add other likelihood function, all you have to do is  initialize new Coherence Class and add the Coherence instance to coherence variable with addPointCoherence function.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">//prepare the model of tracker&#39;s target</span>
<span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector4f</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Affine3f</span><span class="w"> </span><span class="n">trans</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Affine3f</span><span class="o">::</span><span class="n">Identity</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">CloudPtr</span><span class="w"> </span><span class="nf">transed_ref</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Cloud</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">CloudPtr</span><span class="w"> </span><span class="nf">transed_ref_downsampled</span><span class="w"> </span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Cloud</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">compute3DCentroid</span><span class="o">&lt;</span><span class="n">RefPointType</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">target_cloud</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">trans</span><span class="p">.</span><span class="n">translation</span><span class="w"> </span><span class="p">().</span><span class="n">matrix</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3f</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="n">pcl</span><span class="o">::</span><span class="n">transformPointCloud</span><span class="o">&lt;</span><span class="n">RefPointType</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">target_cloud</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">transed_ref</span><span class="p">,</span><span class="w"> </span><span class="n">trans</span><span class="p">.</span><span class="n">inverse</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">gridSampleApprox</span><span class="w"> </span><span class="p">(</span><span class="n">transed_ref</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">transed_ref_downsampled</span><span class="p">,</span><span class="w"> </span><span class="n">downsampling_grid_size_</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="c1">//set reference model and trans</span>
<span class="w">  </span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">setReferenceCloud</span><span class="w"> </span><span class="p">(</span><span class="n">transed_ref_downsampled</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">setTrans</span><span class="w"> </span><span class="p">(</span><span class="n">trans</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>In this part, we set the point cloud loaded from pcd file as reference model to tracker and also set model’s transform values.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">){</span><span class="w"></span>
<span class="w">	</span><span class="n">counter</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">  	</span><span class="c1">//Track the object</span>
<span class="w">	</span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">setInputCloud</span><span class="w"> </span><span class="p">(</span><span class="n">cloud_pass_downsampled_</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">compute</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="w">	</span><span class="n">new_cloud_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Until the counter variable become equal to 10, we ignore the input point cloud, because the point cloud at first few frames often have noise. After counter variable reach to 10 frame, at each loop, we set downsampled input point cloud to tracker and the tracker will compute particles movement.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">ParticleFilter</span><span class="o">::</span><span class="n">PointCloudStatePtr</span><span class="w"> </span><span class="n">particles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">getParticles</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
</pre></div>
</div>
<p>In drawParticles function, you can get particles’s positions by calling getParticles().</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">ParticleXYZRPY</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">getResult</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Affine3f</span><span class="w"> </span><span class="n">transformation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tracker_</span><span class="o">-&gt;</span><span class="n">toEigenMatrix</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>In drawResult function, you can get model information about position and rotation.</p>
</section>
<section id="compiling-and-running-the-program">
<h1>Compiling and running the program</h1>
<p>Create a CMakeLists.txt file and add the following lines into it.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span><span class="w"> </span><span class="s">3.5</span><span class="w"> </span><span class="s">FATAL_ERROR</span><span class="p">)</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="nb">project</span><span class="p">(</span><span class="s">openni_tracking</span><span class="p">)</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="nb">find_package</span><span class="p">(</span><span class="s">PCL</span><span class="w"> </span><span class="s">1.7</span><span class="w"> </span><span class="s">REQUIRED</span><span class="p">)</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="nb">include_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">PCL_INCLUDE_DIRS</span><span class="o">}</span><span class="p">)</span>
<span class="linenos"> 8</span><span class="nb">link_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">PCL_LIBRARY_DIRS</span><span class="o">}</span><span class="p">)</span>
<span class="linenos"> 9</span><span class="nb">add_definitions</span><span class="p">(</span><span class="o">${</span><span class="nv">PCL_DEFINITIONS</span><span class="o">}</span><span class="p">)</span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="nb">add_executable</span> <span class="p">(</span><span class="s">tracking_sample</span><span class="w"> </span><span class="s">tracking_sample.cpp</span><span class="p">)</span>
<span class="linenos">12</span><span class="nb">target_link_libraries</span> <span class="p">(</span><span class="s">tracking_sample</span><span class="w"> </span><span class="o">${</span><span class="nv">PCL_LIBRARIES</span><span class="o">}</span><span class="p">)</span>
</pre></div>
</div>
<p>If you finish saving CMakeLists.txt, let’s prepare for running.</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Put the target object on a plane where there is nothing.</p></li>
<li><p>Put sensor device about 1 meter away from target.</p></li>
<li><p>Don’t move the target and the device until you launch tracking program.</p></li>
<li><p>Output only target point cloud with your other code (See <a class="reference internal" href="planar_segmentation.html#planar-segmentation"><span class="std std-ref">Plane model segmentation</span></a> tutorial) and save as tracking_target.pcd</p></li>
</ol>
</div></blockquote>
<p>After you created model point cloud and the executable, you can then launch tracking_sample. Set device_id as second argument and pcd file’s name you made in above 4 as third.</p>
<blockquote>
<div><p>$ ./tracking_sample “#1” tracking_target.pcd</p>
</div></blockquote>
<p>After few seconds, tracking will start working and you can move tracking object around. As you can see in following pictures, the blue point cloud is reference model segmentation’s cloud and the red one is particles’ cloud.</p>
<a class="reference internal image-reference" href="_images/redone.png"><img alt="_images/redone.png" src="_images/redone.png" style="height: 400px;" /></a>
<a class="reference internal image-reference" href="_images/blueone.png"><img alt="_images/blueone.png" src="_images/blueone.png" style="height: 400px;" /></a>
</section>
<section id="more-advanced">
<h1>More Advanced</h1>
<p>If you want to see more flexible and useful tracking code which starts tracking without preparing to make segmented model beforehand, you should refer a tracking code  <a class="reference external" href="https://github.com/PointCloudLibrary/pcl/blob/master/apps/src/openni_tracking.cpp">https://github.com/PointCloudLibrary/pcl/blob/master/apps/src/openni_tracking.cpp</a>. It will show you better and more legible code. The above Figures  are windows when you implement that code.</p>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>